<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ip-layer-extern.h File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>ip-layer-extern.h File Reference</h1>
<p>
<a href="ip-layer-extern_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td nowrap align=right valign=top>void&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a1">ip_layer_init</a> (ip_layer_state *state, tw_lp *lp)</td></tr>
<tr><td nowrap align=right valign=top>void&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a2">ip_layer_event_handler</a> (ip_layer_state *state, tw_bf *CV, rn_message *msg, tw_lp *lp)</td></tr>
<tr><td nowrap align=right valign=top>void&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a3">ip_layer_rc_event_handler</a> (ip_layer_state *state, tw_bf *CV, rn_message *msg, tw_lp *lp)</td></tr>
<tr><td nowrap align=right valign=top>void&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a4">ip_layer_final</a> (ip_layer_state *state, tw_lp *lp)</td></tr>
<tr><td nowrap align=right valign=top>void&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a5">ip_layer_xml</a> (tw_lp *lp)</td></tr>
<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td nowrap align=right valign=top>int&nbsp;</td><td valign=bottom><a class="el" href="ip-layer-extern_8h.html#a0">g_ip_header</a></td></tr>
</table>
<hr><h2>Function Documentation</h2>
<a name="a2" doxytag="ip-layer-extern.h::ip_layer_event_handler"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ip_layer_event_handler </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ip_layer_state *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>state</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_bf *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>CV</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>rn_message *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>msg</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_lp *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>lp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer_8c-source.html#l00019">19</a> of file <a class="el" href="ip-layer_8c-source.html">ip-layer.c</a>.
<p>
<div class="fragment"><pre>00020 {
00021   tw_stime        ts = 0;
00022 
00023   ip_layer_message *ip_m;
00024   rn_message       *r;
00025   tw_event         *n_evt;
00026   rn_link          *link;
00027   
00028   <span class="keywordflow">switch</span> (msg-&gt;type)
00029     {
00030     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00031       msg-&gt;size -= g_ip_header;
00032       
00033       <span class="keywordflow">return</span>;
00034       
00035     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00036       link = state-&gt;host-&gt;link;
00037       ip_m = rn_message_data_correct(msg, lp);
00038       ip_m-&gt;rc_lastsent = state-&gt;lastsent;
00039 
00040       <span class="keywordflow">if</span> (tw_now(lp) &gt; state-&gt;lastsent)
00041         state-&gt;lastsent = tw_now(lp);
00042       <span class="keywordflow">else</span>
00043         ts = state-&gt;lastsent - tw_now(lp);
00044             
00045       <span class="comment">// should add frequency</span>
00046       <span class="comment">// get next_hop</span>
00047       
00048       msg-&gt;size += g_ip_header;
00049       ts += (msg-&gt;size * 8 / (double) link-&gt;bandwidth  + link-&gt;delay);
00050       state-&gt;lastsent += (msg-&gt;size * 8/ (double) link-&gt;bandwidth );
00051       
00052 
00053       <span class="comment">// look at rn-event.c  for the correct way.     </span>
00054       n_evt = <a class="code" href="rn-event_8c.html#a1">rn_event_new</a>(state-&gt;next_hop , ts , lp, msg-&gt;size);
00055      
00056       r = <a class="code" href="rn-event_8c.html#a2">rn_event_data</a>(n_evt);
00057       <a class="code" href="rn-message_8c.html#a3">rn_message_setdirection</a>(r,<a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>);
00058       memcpy(r, msg,g_message_size);
00059       n_evt-&gt;dest_lp = tw_getlp(state-&gt;next_hop-&gt;id);
00060       <span class="keywordflow">if</span>(n_evt-&gt;dest_lp-&gt;id != state-&gt;next_hop-&gt;id)
00061         printf(<span class="stringliteral">"part of the problem is found\n"</span>);
00062       n_evt-&gt;message-&gt;dest_lp = state-&gt;next_hop-&gt;id;
00063       <a class="code" href="rn-event_8c.html#a3">rn_event_send</a>(n_evt);
00064       <span class="keywordflow">break</span>;
00065     <span class="keywordflow">default</span>:
00066       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d %f\n"</span>,
00067                msg-&gt;type, tw_now(lp));
00068     }
00069 }
</pre></div>    </td>
  </tr>
</table>
<a name="a4" doxytag="ip-layer-extern.h::ip_layer_final"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ip_layer_final </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ip_layer_state *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>state</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_lp *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>lp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer_8c-source.html#l00096">96</a> of file <a class="el" href="ip-layer_8c-source.html">ip-layer.c</a>.
<p>
<div class="fragment"><pre>00097 {
00098 
00099 }
</pre></div>    </td>
  </tr>
</table>
<a name="a1" doxytag="ip-layer-extern.h::ip_layer_init"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ip_layer_init </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ip_layer_state *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>state</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_lp *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>lp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer_8c-source.html#l00011">11</a> of file <a class="el" href="ip-layer_8c-source.html">ip-layer.c</a>.
<p>
<div class="fragment"><pre>00012 {
00013   state-&gt;host = <a class="code" href="rn-machine_8c.html#a0">rn_getmachine</a>(lp-&gt;id);
00014   state-&gt;next_hop = tw_getlp(state-&gt;host-&gt;link-&gt;addr);
00015 }
</pre></div>    </td>
  </tr>
</table>
<a name="a3" doxytag="ip-layer-extern.h::ip_layer_rc_event_handler"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ip_layer_rc_event_handler </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ip_layer_state *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>state</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_bf *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>CV</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>rn_message *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>msg</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>tw_lp *&nbsp;</td>
          <td class="mdname" nowrap>&nbsp; <em>lp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer_8c-source.html#l00074">74</a> of file <a class="el" href="ip-layer_8c-source.html">ip-layer.c</a>.
<p>
<div class="fragment"><pre>00075 {
00076   ip_layer_message *ip_m;
00077   
00078   <span class="keywordflow">switch</span> (msg-&gt;type)
00079     {
00080     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00081       msg-&gt;size += g_ip_header;
00082       <span class="keywordflow">return</span>;
00083       
00084     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00085       ip_m = <a class="code" href="rn-message_8c.html#a2">rn_message_data</a>(msg);
00086       state-&gt;lastsent = ip_m-&gt;rc_lastsent;
00087       <span class="keywordflow">break</span>;
00088 
00089     <span class="keywordflow">default</span>:
00090       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d\n"</span>,
00091                msg-&gt;type);
00092     }
00093 }
</pre></div>    </td>
  </tr>
</table>
<a name="a5" doxytag="ip-layer-extern.h::ip_layer_xml"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ip_layer_xml </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">tw_lp *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>&nbsp; <em>lp</em>          </td>
          <td class="md" valign="top">)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer_8c-source.html#l00102">102</a> of file <a class="el" href="ip-layer_8c-source.html">ip-layer.c</a>.
<p>
<div class="fragment"><pre>00103 {
00104         xmlXPathObjectPtr       obj;
00105         xmlNodePtr              node;
00106         xmlNodePtr              layer;
00107         
00108         <span class="keywordtype">char</span>                    expr[30];
00109 
00110         <span class="comment">//tw_mutex_lock(&amp;g_tw_debug_lck);</span>
00111 
00112         ctxt = xmlXPathNewContext(document);
00113         ctxt-&gt;node = xmlDocGetRootElement(document);
00114 
00115         <span class="comment">/* This expression gets the node with our lp id */</span>
00116         sprintf(expr, <span class="stringliteral">"//node[@id=\'%d\']"</span>, lp-&gt;id);
00117 
00118         obj = <a class="code" href="xml-libxml_8c.html#a3">xpath</a>(expr);
00119         node = *obj-&gt;nodesetval-&gt;nodeTab;
00120 
00121         layer = node-&gt;children;
00122         <span class="keywordflow">while</span>(layer)
00123         {
00124                 <span class="keywordflow">if</span>(0 != strcmp(layer-&gt;name, <span class="stringliteral">"layer"</span>))
00125                 {
00126                         layer = layer-&gt;next;
00127                         <span class="keywordflow">continue</span>;
00128                 }
00129 
00130                 <span class="keywordflow">if</span>(strcmp(<a class="code" href="xml-libxml_8c.html#a7">xml_getprop</a>(layer, <span class="stringliteral">"name"</span>), <span class="stringliteral">"ip"</span>) == 0)
00131                 {
00132                         tw_lp_settype(lp, IP_LAYER_LP_TYPE);
00133                         printf(<span class="stringliteral">"Setting LP %d to IP! \n"</span>, lp-&gt;id);
00134                 }
00135 
00136                 <span class="keywordflow">if</span>(layer == node-&gt;last)
00137                         <span class="keywordflow">break</span>;
00138                 <span class="keywordflow">else</span>
00139                         layer = layer-&gt;next;
00140         }
00141         xmlXPathFreeObject(obj);
00142 }
</pre></div>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a name="a0" doxytag="ip-layer-extern.h::g_ip_header"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int g_ip_header
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="ip-layer-extern_8h-source.html#l00018">18</a> of file <a class="el" href="ip-layer-extern_8h-source.html">ip-layer-extern.h</a>.    </td>
  </tr>
</table>
<hr><address style="align: right;"><small>Generated on Tue Apr 12 17:46:15 2005 for ROSS.Net by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
