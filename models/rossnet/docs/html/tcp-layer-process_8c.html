<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ROSS.Net: tcp-layer-process.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>tcp-layer-process.c File Reference</h1>
<p>
<code>#include &lt;<a class="el" href="tcp-layer_8h-source.html">tcp-layer.h</a>&gt;</code><br>

<p>
<a href="tcp-layer-process_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcp-layer-process_8c.html#e0c83c37a59cbb927cfc5037c019e2d6">tcp_layer_process_ack</a> (tcp_layer_state *SV, tw_bf *CV, rn_message *msg, tw_lp *lp)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcp-layer-process_8c.html#d9712cc88bb2db9d155114aba3252316">tcp_layer_process_data</a> (tcp_layer_state *SV, tw_bf *CV, rn_message *rn_msg, tw_lp *lp)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcp-layer-process_8c.html#40881a25b74ab2f7cf69e251c8598f92">tcp_layer_update_cwnd</a> (tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcp-layer-process_8c.html#dbe501fe541207df187f2d9e98d7f4f7">tcp_layer_update_rtt</a> (tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcp-layer-process_8c.html#a247a56daeeaee8028f102b3ef0a5c92">tcp_layer_timeout</a> (tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="e0c83c37a59cbb927cfc5037c019e2d6"></a><!-- doxytag: member="tcp-layer-process.c::tcp_layer_process_ack" ref="e0c83c37a59cbb927cfc5037c019e2d6" args="(tcp_layer_state *SV, tw_bf *CV, rn_message *msg, tw_lp *lp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tcp_layer_process_ack           </td>
          <td>(</td>
          <td class="paramtype">tcp_layer_state *&nbsp;</td>
          <td class="paramname"> <em>SV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_bf *&nbsp;</td>
          <td class="paramname"> <em>CV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rn_message *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>lp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="tcp-layer-process_8c-source.html#l00008">8</a> of file <a class="el" href="tcp-layer-process_8c-source.html">tcp-layer-process.c</a>.</p>

<p>References <a class="el" href="tcp-layer-types_8h-source.html#l00004">FORWARD</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00005">g_tcp_layer_mss</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00004">g_tcp_layer_recv_wnd</a>, <a class="el" href="rn-message_8c-source.html#l00016">rn_message_data()</a>, <a class="el" href="rn-timer_8c-source.html#l00058">rn_timer_reset()</a>, <a class="el" href="tcp-layer-types_8h-source.html#l00010">TCP_LAYER_TRANSFER_SIZE</a>, <a class="el" href="tcp-layer-process_8c-source.html#l00188">tcp_layer_update_cwnd()</a>, <a class="el" href="tcp-layer-process_8c-source.html#l00210">tcp_layer_update_rtt()</a>, and <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>.</p>

<p>Referenced by <a class="el" href="tcp-layer_8c-source.html#l00073">tcp_layer_event_handler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00009"></a>00009 {
<a name="l00010"></a>00010   <span class="keywordtype">int</span>             ack;
<a name="l00011"></a>00011   tw_stime        ts;
<a name="l00012"></a>00012   tcp_layer_message    *M;
<a name="l00013"></a>00013   
<a name="l00014"></a>00014   ts = 0.0;
<a name="l00015"></a>00015   M = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(msg);
<a name="l00016"></a>00016   
<a name="l00017"></a>00017   
<a name="l00018"></a>00018   <span class="keywordflow">if</span> ((CV-&gt;c2 = (SV-&gt;unack &lt;= M-&gt;ack)))
<a name="l00019"></a>00019     {
<a name="l00020"></a>00020         <span class="keywordflow">if</span> ((CV-&gt;c9 = (M-&gt;ack &gt;= SV-&gt;seq_num)))
<a name="l00021"></a>00021         {                                               <span class="comment">// CHANGE</span>
<a name="l00022"></a>00022           M-&gt;RC.seq_num = SV-&gt;seq_num;
<a name="l00023"></a>00023           SV-&gt;seq_num = M-&gt;ack + <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00024"></a>00024         }
<a name="l00025"></a>00025       
<a name="l00026"></a>00026       M-&gt;RC.dup_count = SV-&gt;dup_count;
<a name="l00027"></a>00027       SV-&gt;dup_count = 0;
<a name="l00028"></a>00028       
<a name="l00029"></a>00029       ack = SV-&gt;unack;
<a name="l00030"></a>00030       SV-&gt;unack = M-&gt;ack + <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00031"></a>00031       <a class="code" href="tcp-layer-extern_8h.html#40881a25b74ab2f7cf69e251c8598f92">tcp_layer_update_cwnd</a>(SV, CV, M, lp);
<a name="l00032"></a>00032       
<a name="l00033"></a>00033       <span class="comment">/*</span>
<a name="l00034"></a>00034 <span class="comment">       * Prints the time it took to transfer, the rate and congestion</span>
<a name="l00035"></a>00035 <span class="comment">       * window size     </span>
<a name="l00036"></a>00036 <span class="comment">       */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038       <span class="keywordflow">if</span> (SV-&gt;unack &gt;= SV-&gt;len)
<a name="l00039"></a>00039         {
<a name="l00040"></a>00040           printf(<span class="stringliteral">"\n\t\tTransfer Time = %f at %f kbps \n\t\tCWND = %f lp = %ld\n\n"</span>,
<a name="l00041"></a>00041              (tw_now(lp) - SV-&gt;start_time) ,
<a name="l00042"></a>00042              ((SV-&gt;len) / (tw_now(lp) - SV-&gt;start_time))/ 1000, 
<a name="l00043"></a>00043              SV-&gt;cwnd, lp-&gt;id);   
<a name="l00044"></a>00044         }
<a name="l00045"></a>00045 
<a name="l00046"></a>00046       <a class="code" href="tcp-layer-extern_8h.html#dbe501fe541207df187f2d9e98d7f4f7">tcp_layer_update_rtt</a>(SV, CV, M, lp);
<a name="l00047"></a>00047       
<a name="l00048"></a>00048       M-&gt;seq_num = 0;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050       <span class="keywordflow">while</span> (SV-&gt;seq_num &lt; SV-&gt;len &amp;&amp;
<a name="l00051"></a>00051              (SV-&gt;seq_num + <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>) &lt;=
<a name="l00052"></a>00052              (SV-&gt;unack + min(SV-&gt;cwnd, <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a>) * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>))
<a name="l00053"></a>00053         {
<a name="l00054"></a>00054           M-&gt;seq_num++;
<a name="l00055"></a>00055           <a class="code" href="tcp-layer-extern_8h.html#c39d666f511055e405e9746941f64a2a">tcp_layer_util_event</a>(lp, <a class="code" href="tcp-layer-types_8h.html#6ddfdda7a062d10cff4a72b76b44aeb8">FORWARD</a>, lp-&gt;id, M-&gt;source, SV-&gt;seq_num, 0, 
<a name="l00056"></a>00056                                <a class="code" href="tcp-layer-types_8h.html#d6bafeaf3f6cb454be1b540be9dced72">TCP_LAYER_TRANSFER_SIZE</a>);
<a name="l00057"></a>00057           SV-&gt;sent_packets++;
<a name="l00058"></a>00058           SV-&gt;seq_num += g_tcp_layer_mss;
<a name="l00059"></a>00059           <span class="comment">//if(SV-&gt;seq_num &lt; 0 )</span>
<a name="l00060"></a>00060           <span class="comment">// tw_error(TW_LOC,"OverFlow\n");</span>
<a name="l00061"></a>00061         }
<a name="l00062"></a>00062       M-&gt;ack = ack;
<a name="l00063"></a>00063     } <span class="keywordflow">else</span>
<a name="l00064"></a>00064       {
<a name="l00065"></a>00065         <span class="comment">// printf("Invalid Ack %d\n", M-&gt;ack);</span>
<a name="l00066"></a>00066         <span class="keywordflow">if</span> ((CV-&gt;c3 = ((SV-&gt;unack - <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>) == M-&gt;ack)))
<a name="l00067"></a>00067           {
<a name="l00068"></a>00068             SV-&gt;dup_count += 1;
<a name="l00069"></a>00069             <span class="keywordflow">if</span> ((CV-&gt;c4 = (SV-&gt;dup_count == 4)))
<a name="l00070"></a>00070               {
<a name="l00071"></a>00071                 
<a name="l00072"></a>00072                 M-&gt;dest = SV-&gt;ssthresh;
<a name="l00073"></a>00073                 SV-&gt;ssthresh =
<a name="l00074"></a>00074                   (min(((<span class="keywordtype">int</span>)SV-&gt;cwnd + 1), <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a>) / 2) * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00075"></a>00075                                 <span class="comment">// CHANGED</span>
<a name="l00076"></a>00076                 M-&gt;RC.cwnd = SV-&gt;cwnd;
<a name="l00077"></a>00077                 SV-&gt;cwnd = 1;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079                 <a class="code" href="tcp-layer-extern_8h.html#c39d666f511055e405e9746941f64a2a">tcp_layer_util_event</a>(lp, <a class="code" href="tcp-layer-types_8h.html#6ddfdda7a062d10cff4a72b76b44aeb8">FORWARD</a>, lp-&gt;id,
<a name="l00080"></a>00080                                M-&gt;source, SV-&gt;unack, 0, <a class="code" href="tcp-layer-types_8h.html#d6bafeaf3f6cb454be1b540be9dced72">TCP_LAYER_TRANSFER_SIZE</a>);
<a name="l00081"></a>00081                 
<a name="l00082"></a>00082                 M-&gt;ack = SV-&gt;seq_num;
<a name="l00083"></a>00083                 SV-&gt;seq_num = SV-&gt;unack + <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00084"></a>00084                 
<a name="l00085"></a>00085                                 <span class="comment">// CHANGE MAYBE.</span>
<a name="l00086"></a>00086                 SV-&gt;rto_seq++;
<a name="l00087"></a>00087                 <span class="comment">//tcp_layer_util_event(lp, RTO, M-&gt;source, lp-&gt;id, SV-&gt;unack,</span>
<a name="l00088"></a>00088                 <span class="comment">//             SV-&gt;rto_seq, SV-&gt;rto);</span>
<a name="l00089"></a>00089                 
<a name="l00090"></a>00090                 <span class="keywordflow">if</span>((CV-&gt;c13 = (SV-&gt;timer != NULL))) {
<a name="l00091"></a>00091                   rn_message *rn_m;
<a name="l00092"></a>00092                   tcp_layer_message *m1;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094                   rn_m = tw_event_data(SV-&gt;timer); 
<a name="l00095"></a>00095                   m1 = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(rn_m);
<a name="l00096"></a>00096                   M-&gt;RC.timer_ts = SV-&gt;timer-&gt;recv_ts;
<a name="l00097"></a>00097                   M-&gt;RC.timer_seq = m1-&gt;seq_num;
<a name="l00098"></a>00098                   
<a name="l00099"></a>00099                   <a class="code" href="rn-extern_8h.html#5b99d884fbe86665c417897138aff8a6">rn_timer_reset</a>(lp, &amp;(SV-&gt;timer), tw_now(lp) + SV-&gt;rto);
<a name="l00100"></a>00100                   
<a name="l00101"></a>00101                   <span class="keywordflow">if</span>(SV-&gt;timer) 
<a name="l00102"></a>00102                     m1-&gt;seq_num = SV-&gt;unack;
<a name="l00103"></a>00103                 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105                 M-&gt;RC.seq_num = SV-&gt;rtt_seq;
<a name="l00106"></a>00106                 SV-&gt;rtt_seq = SV-&gt;unack;
<a name="l00107"></a>00107                 M-&gt;RC.rtt_time = SV-&gt;rtt_time;
<a name="l00108"></a>00108                 SV-&gt;rtt_time = 0;
<a name="l00109"></a>00109               }
<a name="l00110"></a>00110           }
<a name="l00111"></a>00111       }
<a name="l00112"></a>00112 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="d9712cc88bb2db9d155114aba3252316"></a><!-- doxytag: member="tcp-layer-process.c::tcp_layer_process_data" ref="d9712cc88bb2db9d155114aba3252316" args="(tcp_layer_state *SV, tw_bf *CV, rn_message *rn_msg, tw_lp *lp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tcp_layer_process_data           </td>
          <td>(</td>
          <td class="paramtype">tcp_layer_state *&nbsp;</td>
          <td class="paramname"> <em>SV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_bf *&nbsp;</td>
          <td class="paramname"> <em>CV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rn_message *&nbsp;</td>
          <td class="paramname"> <em>rn_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>lp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="tcp-layer-process_8c-source.html#l00119">119</a> of file <a class="el" href="tcp-layer-process_8c-source.html">tcp-layer-process.c</a>.</p>

<p>References <a class="el" href="tcp-layer-types_8h-source.html#l00004">FORWARD</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00005">g_tcp_layer_mss</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00004">g_tcp_layer_recv_wnd</a>, <a class="el" href="rn-message_8c-source.html#l00016">rn_message_data()</a>, <a class="el" href="tcp-layer-types_8h-source.html#l00009">TCP_LAYER_HEADER_SIZE</a>, <a class="el" href="tcp-layer-types_8h-source.html#l00008">TCP_LAYER_SND_WND</a>, and <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>.</p>

<p>Referenced by <a class="el" href="tcp-layer_8c-source.html#l00073">tcp_layer_event_handler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00121"></a>00121 {
<a name="l00122"></a>00122   <span class="comment">//int             id_offset;</span>
<a name="l00123"></a>00123   tcp_layer_message    *M;
<a name="l00124"></a>00124   
<a name="l00125"></a>00125   tw_stime        ts;
<a name="l00126"></a>00126   
<a name="l00127"></a>00127   ts = 0.0;
<a name="l00128"></a>00128   M = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(rn_msg);
<a name="l00129"></a>00129   <span class="comment">//id_offset = lp-&gt;id;</span>
<a name="l00130"></a>00130   
<a name="l00131"></a>00131   <span class="keywordflow">if</span> ((CV-&gt;c2 = (M-&gt;seq_num == SV-&gt;seq_num)))
<a name="l00132"></a>00132     {
<a name="l00133"></a>00133       SV-&gt;received_packets++;
<a name="l00134"></a>00134       
<a name="l00135"></a>00135       M-&gt;RC.dup_count = 0;
<a name="l00136"></a>00136       SV-&gt;seq_num += <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00137"></a>00137       <span class="keywordflow">while</span> (SV-&gt;out_of_order[(SV-&gt;seq_num / (<span class="keywordtype">int</span>)<a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>) % <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a>])
<a name="l00138"></a>00138         {       
<a name="l00139"></a>00139           M-&gt;RC.dup_count++;
<a name="l00140"></a>00140           SV-&gt;out_of_order[(SV-&gt;seq_num / (int)g_tcp_layer_mss) % g_tcp_layer_recv_wnd] = 0;
<a name="l00141"></a>00141           SV-&gt;seq_num += g_tcp_layer_mss;
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143           
<a name="l00144"></a>00144       <a class="code" href="tcp-layer-extern_8h.html#c39d666f511055e405e9746941f64a2a">tcp_layer_util_event</a>(lp, <a class="code" href="tcp-layer-types_8h.html#6ddfdda7a062d10cff4a72b76b44aeb8">FORWARD</a>, lp-&gt;id, M-&gt;source,
<a name="l00145"></a>00145                            0, SV-&gt;seq_num - g_tcp_layer_mss, <a class="code" href="tcp-layer-types_8h.html#5c0ec6ca6c0eeb059c8db978bb4899be">TCP_LAYER_HEADER_SIZE</a>);
<a name="l00146"></a>00146       
<a name="l00147"></a>00147       <span class="comment">// printf("SV-&gt;seq %d and rn_msg %ld\n",SV-&gt;seq_num, rn_msg-&gt;size);</span>
<a name="l00148"></a>00148       
<a name="l00149"></a>00149         } 
<a name="l00150"></a>00150   <span class="keywordflow">else</span>
<a name="l00151"></a>00151     { 
<a name="l00152"></a>00152       <span class="keywordflow">if</span> ((CV-&gt;c3 = (M-&gt;seq_num &gt; SV-&gt;seq_num)))
<a name="l00153"></a>00153         {
<a name="l00154"></a>00154           <span class="keywordflow">if</span> ((CV-&gt;c4 = (M-&gt;seq_num &gt; (SV-&gt;seq_num + <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a> * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>
<a name="l00155"></a>00155                                        <span class="comment">/*</span>
<a name="l00156"></a>00156 <span class="comment">                                        * TCP_LAYER_SND_WND </span>
<a name="l00157"></a>00157 <span class="comment">                                        */</span>  - <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>))))
<a name="l00158"></a>00158             {
<a name="l00159"></a>00159                                 <span class="comment">// look up need rc code  CHANGE</span>
<a name="l00160"></a>00160               tw_error(TW_LOC, <span class="stringliteral">"revc_wnd buffer overflow %d %d\n"</span>,
<a name="l00161"></a>00161                        M-&gt;seq_num, SV-&gt;seq_num + <a class="code" href="tcp-layer-types_8h.html#b5793107ea01a6934a2dc752e19d8a4d">TCP_LAYER_SND_WND</a> - <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>);
<a name="l00162"></a>00162             } 
<a name="l00163"></a>00163           <span class="keywordflow">else</span>
<a name="l00164"></a>00164             {
<a name="l00165"></a>00165               <span class="comment">/*</span>
<a name="l00166"></a>00166 <span class="comment">                printf("M %d window %d, loc %d\n",</span>
<a name="l00167"></a>00167 <span class="comment">                M-&gt;seq_num,</span>
<a name="l00168"></a>00168 <span class="comment">                (SV-&gt;seq_num + TCP_LAYER_SND_WND - g_tcp_layer_mss),</span>
<a name="l00169"></a>00169 <span class="comment">                  (M-&gt;seq_num / g_tcp_layer_mss) % g_tcp_layer_recv_wnd);</span>
<a name="l00170"></a>00170 <span class="comment">              */</span>
<a name="l00171"></a>00171               SV-&gt;out_of_order[(M-&gt;seq_num / <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>) % <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a>] = 1;
<a name="l00172"></a>00172             }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174       
<a name="l00175"></a>00175       <a class="code" href="tcp-layer-extern_8h.html#c39d666f511055e405e9746941f64a2a">tcp_layer_util_event</a>(lp, <a class="code" href="tcp-layer-types_8h.html#6ddfdda7a062d10cff4a72b76b44aeb8">FORWARD</a>, lp-&gt;id, M-&gt;source,
<a name="l00176"></a>00176                            0, SV-&gt;seq_num - <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>, <a class="code" href="tcp-layer-types_8h.html#5c0ec6ca6c0eeb059c8db978bb4899be">TCP_LAYER_HEADER_SIZE</a>);
<a name="l00177"></a>00177       
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179   
<a name="l00180"></a>00180 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a247a56daeeaee8028f102b3ef0a5c92"></a><!-- doxytag: member="tcp-layer-process.c::tcp_layer_timeout" ref="a247a56daeeaee8028f102b3ef0a5c92" args="(tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tcp_layer_timeout           </td>
          <td>(</td>
          <td class="paramtype">tcp_layer_state *&nbsp;</td>
          <td class="paramname"> <em>SV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_bf *&nbsp;</td>
          <td class="paramname"> <em>CV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tcp_layer_message *&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>lp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="tcp-layer-process_8c-source.html#l00271">271</a> of file <a class="el" href="tcp-layer-process_8c-source.html">tcp-layer-process.c</a>.</p>

<p>References <a class="el" href="tcp-layer-types_8h-source.html#l00004">FORWARD</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00005">g_tcp_layer_mss</a>, <a class="el" href="tcp-layer-global_8c-source.html#l00004">g_tcp_layer_recv_wnd</a>, <a class="el" href="rn-message_8c-source.html#l00016">rn_message_data()</a>, <a class="el" href="rn-timer_8c-source.html#l00030">rn_timer_init()</a>, <a class="el" href="tcp-layer-types_8h-source.html#l00005">RTO</a>, <a class="el" href="tcp-layer-types_8h-source.html#l00009">TCP_LAYER_HEADER_SIZE</a>, and <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>.</p>

<p>Referenced by <a class="el" href="tcp-layer_8c-source.html#l00073">tcp_layer_event_handler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00272"></a>00272 {
<a name="l00273"></a>00273   
<a name="l00274"></a>00274   <span class="comment">// printf("bw %d de %f last %f \n", SV-&gt;host-&gt;link-&gt;bandwidth,  </span>
<a name="l00275"></a>00275   <span class="comment">// SV-&gt;host-&gt;link-&gt;delay,  SV-&gt;lastsent);</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="keywordflow">if</span> ((CV-&gt;c1 = (M-&gt;seq_num &gt;= SV-&gt;unack &amp;&amp; SV-&gt;unack &lt; SV-&gt;len)))
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279       <span class="comment">//printf("should timeout %f %d %f\n", tw_now(lp), lp-&gt;id, SV-&gt;lastsent );</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281       M-&gt;dest = SV-&gt;ssthresh;
<a name="l00282"></a>00282       SV-&gt;ssthresh = (min(((<span class="keywordtype">int</span>)SV-&gt;cwnd + 1), <a class="code" href="tcp-layer-extern_8h.html#e860eb4375a893ce246d586c4b212ac1">g_tcp_layer_recv_wnd</a>) / 2) * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00283"></a>00283       <span class="comment">// CHANGED</span>
<a name="l00284"></a>00284       M-&gt;RC.cwnd = SV-&gt;cwnd;
<a name="l00285"></a>00285       SV-&gt;cwnd = 1;
<a name="l00286"></a>00286       
<a name="l00287"></a>00287       <span class="comment">//printf("bw %d de %f last %f \n", SV-&gt;host-&gt;link-&gt;bandwidth,  </span>
<a name="l00288"></a>00288       <span class="comment">//     SV-&gt;host-&gt;link-&gt;delay,  SV-&gt;lastsent);</span>
<a name="l00289"></a>00289 
<a name="l00290"></a>00290       <a class="code" href="tcp-layer-extern_8h.html#c39d666f511055e405e9746941f64a2a">tcp_layer_util_event</a>(lp, <a class="code" href="tcp-layer-types_8h.html#6ddfdda7a062d10cff4a72b76b44aeb8">FORWARD</a>, lp-&gt;id, M-&gt;source, SV-&gt;unack, 0,
<a name="l00291"></a>00291                      <a class="code" href="tcp-layer-types_8h.html#5c0ec6ca6c0eeb059c8db978bb4899be">TCP_LAYER_HEADER_SIZE</a>);
<a name="l00292"></a>00292       
<a name="l00293"></a>00293       M-&gt;ack = SV-&gt;seq_num;
<a name="l00294"></a>00294       SV-&gt;seq_num = SV-&gt;unack + <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>;
<a name="l00295"></a>00295       SV-&gt;timedout_packets++;
<a name="l00296"></a>00296       
<a name="l00297"></a>00297       M-&gt;RC.dup_count = SV-&gt;rto;
<a name="l00298"></a>00298       SV-&gt;rto = SV-&gt;rto * 2;    <span class="comment">// PUT IN MAX TIME CHANGE</span>
<a name="l00299"></a>00299       <span class="comment">// M-&gt;RC.event = SV-&gt;event;</span>
<a name="l00300"></a>00300       
<a name="l00301"></a>00301       SV-&gt;rto_seq++;
<a name="l00302"></a>00302       <span class="comment">//tcp_layer_util_event(lp, RTO, M-&gt;source, lp-&gt;id, SV-&gt;unack, SV-&gt;rto_seq,</span>
<a name="l00303"></a>00303       <span class="comment">//             SV-&gt;rto);</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305       M-&gt;RC.timer = SV-&gt;timer;
<a name="l00306"></a>00306       SV-&gt;timer = <a class="code" href="rn-extern_8h.html#0ac1d7574bf764f8813b77b2ee72d79d">rn_timer_init</a>(lp, tw_now(lp) + SV-&gt;rto);
<a name="l00307"></a>00307       
<a name="l00308"></a>00308       <span class="keywordflow">if</span>((CV-&gt;c13 = (SV-&gt;timer != NULL))){
<a name="l00309"></a>00309         rn_message *rn_m = tw_event_data(SV-&gt;timer);
<a name="l00310"></a>00310         tcp_layer_message *M1 = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(rn_m);
<a name="l00311"></a>00311         M1-&gt;source = M-&gt;source;
<a name="l00312"></a>00312         M1-&gt;seq_num= SV-&gt;unack;
<a name="l00313"></a>00313         M1-&gt;MethodName = <a class="code" href="tcp-layer-types_8h.html#d1ae8a44d7a6f5cb3dd62a18369c163c">RTO</a>;
<a name="l00314"></a>00314       }
<a name="l00315"></a>00315       
<a name="l00316"></a>00316       M-&gt;RC.rtt_seq = SV-&gt;rtt_seq;
<a name="l00317"></a>00317       SV-&gt;rtt_seq = SV-&gt;unack;
<a name="l00318"></a>00318       M-&gt;RC.rtt_time = SV-&gt;rtt_time;
<a name="l00319"></a>00319       SV-&gt;rtt_time = 0;
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="40881a25b74ab2f7cf69e251c8598f92"></a><!-- doxytag: member="tcp-layer-process.c::tcp_layer_update_cwnd" ref="40881a25b74ab2f7cf69e251c8598f92" args="(tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tcp_layer_update_cwnd           </td>
          <td>(</td>
          <td class="paramtype">tcp_layer_state *&nbsp;</td>
          <td class="paramname"> <em>SV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_bf *&nbsp;</td>
          <td class="paramname"> <em>CV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tcp_layer_message *&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>lp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="tcp-layer-process_8c-source.html#l00188">188</a> of file <a class="el" href="tcp-layer-process_8c-source.html">tcp-layer-process.c</a>.</p>

<p>References <a class="el" href="tcp-layer-global_8c-source.html#l00005">g_tcp_layer_mss</a>, and <a class="el" href="tcp-layer-types_8h-source.html#l00008">TCP_LAYER_SND_WND</a>.</p>

<p>Referenced by <a class="el" href="tcp-layer-process_8c-source.html#l00008">tcp_layer_process_ack()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00189"></a>00189 {
<a name="l00190"></a>00190   <span class="keywordflow">if</span> (
<a name="l00191"></a>00191       (CV-&gt;c3 =
<a name="l00192"></a>00192        ((SV-&gt;cwnd * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a>) &lt; SV-&gt;ssthresh &amp;&amp; SV-&gt;cwnd * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a> &lt; <a class="code" href="tcp-layer-types_8h.html#b5793107ea01a6934a2dc752e19d8a4d">TCP_LAYER_SND_WND</a>)))
<a name="l00193"></a>00193     {
<a name="l00194"></a>00194       M-&gt;RC.cwnd = SV-&gt;cwnd;
<a name="l00195"></a>00195       SV-&gt;cwnd += 1;
<a name="l00196"></a>00196     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((CV-&gt;c4 = (SV-&gt;cwnd * <a class="code" href="tcp-layer-extern_8h.html#8fdef026b9a7db11c791b9a7f07383df">g_tcp_layer_mss</a> &lt; <a class="code" href="tcp-layer-types_8h.html#b5793107ea01a6934a2dc752e19d8a4d">TCP_LAYER_SND_WND</a>)))
<a name="l00197"></a>00197       {
<a name="l00198"></a>00198         M-&gt;RC.cwnd = SV-&gt;cwnd;
<a name="l00199"></a>00199         SV-&gt;cwnd += 1 / SV-&gt;cwnd;
<a name="l00200"></a>00200       }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="dbe501fe541207df187f2d9e98d7f4f7"></a><!-- doxytag: member="tcp-layer-process.c::tcp_layer_update_rtt" ref="dbe501fe541207df187f2d9e98d7f4f7" args="(tcp_layer_state *SV, tw_bf *CV, tcp_layer_message *M, tw_lp *lp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tcp_layer_update_rtt           </td>
          <td>(</td>
          <td class="paramtype">tcp_layer_state *&nbsp;</td>
          <td class="paramname"> <em>SV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_bf *&nbsp;</td>
          <td class="paramname"> <em>CV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tcp_layer_message *&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>lp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="tcp-layer-process_8c-source.html#l00210">210</a> of file <a class="el" href="tcp-layer-process_8c-source.html">tcp-layer-process.c</a>.</p>

<p>References <a class="el" href="rn-message_8c-source.html#l00016">rn_message_data()</a>, and <a class="el" href="rn-timer_8c-source.html#l00058">rn_timer_reset()</a>.</p>

<p>Referenced by <a class="el" href="tcp-layer-process_8c-source.html#l00008">tcp_layer_process_ack()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00211"></a>00211 {
<a name="l00212"></a>00212   
<a name="l00213"></a>00213   <span class="keywordflow">if</span> ((CV-&gt;c5 = (M-&gt;ack == SV-&gt;rtt_seq &amp;&amp; SV-&gt;unack &lt; SV-&gt;len)))
<a name="l00214"></a>00214     {
<a name="l00215"></a>00215       <span class="keywordflow">if</span> ((CV-&gt;c6 = (SV-&gt;rtt_time != 0)))
<a name="l00216"></a>00216         {
<a name="l00217"></a>00217           M-&gt;dest = SV-&gt;rto;
<a name="l00218"></a>00218           SV-&gt;rto =
<a name="l00219"></a>00219             .875 * SV-&gt;rto + (10 * (tw_now(lp) - SV-&gt;rtt_time)) * .125;
<a name="l00220"></a>00220           
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222       M-&gt;RC.rtt_seq = SV-&gt;rtt_seq;
<a name="l00223"></a>00223       M-&gt;RC.rtt_time = SV-&gt;rtt_time;
<a name="l00224"></a>00224       SV-&gt;rtt_time = tw_now(lp);
<a name="l00225"></a>00225       SV-&gt;rtt_seq = SV-&gt;seq_num;
<a name="l00226"></a>00226       
<a name="l00227"></a>00227       SV-&gt;rto_seq++;
<a name="l00228"></a>00228       
<a name="l00229"></a>00229       <span class="keywordflow">if</span>((CV-&gt;c13 = (SV-&gt;timer != NULL))) {
<a name="l00230"></a>00230         rn_message *rn_m = tw_event_data(SV-&gt;timer);
<a name="l00231"></a>00231         tcp_layer_message *m1 = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(rn_m);
<a name="l00232"></a>00232         M-&gt;RC.timer_ts = SV-&gt;timer-&gt;recv_ts;
<a name="l00233"></a>00233         M-&gt;RC.timer_seq = m1-&gt;seq_num;
<a name="l00234"></a>00234         
<a name="l00235"></a>00235         <a class="code" href="rn-extern_8h.html#5b99d884fbe86665c417897138aff8a6">rn_timer_reset</a>(lp, &amp;(SV-&gt;timer), tw_now(lp) + SV-&gt;rto);
<a name="l00236"></a>00236         
<a name="l00237"></a>00237         <span class="keywordflow">if</span>(SV-&gt;timer) 
<a name="l00238"></a>00238           m1-&gt;seq_num = SV-&gt;unack;
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((CV-&gt;c7 = (M-&gt;ack &gt; SV-&gt;rtt_seq &amp;&amp; SV-&gt;unack &lt; SV-&gt;len)))
<a name="l00242"></a>00242       {
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         M-&gt;RC.rtt_seq = SV-&gt;rtt_seq;
<a name="l00245"></a>00245         M-&gt;RC.rtt_time = SV-&gt;rtt_time;
<a name="l00246"></a>00246         SV-&gt;rtt_time = tw_now(lp);
<a name="l00247"></a>00247         SV-&gt;rtt_seq = SV-&gt;seq_num;
<a name="l00248"></a>00248         
<a name="l00249"></a>00249         SV-&gt;rto_seq++;
<a name="l00250"></a>00250         
<a name="l00251"></a>00251         <span class="keywordflow">if</span>((CV-&gt;c13 = (SV-&gt;timer != NULL))) {
<a name="l00252"></a>00252           rn_message *rn_m = tw_event_data(SV-&gt;timer);
<a name="l00253"></a>00253           tcp_layer_message *m1 = <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>(rn_m);
<a name="l00254"></a>00254           M-&gt;RC.timer_ts = SV-&gt;timer-&gt;recv_ts;
<a name="l00255"></a>00255           M-&gt;RC.timer_seq = m1-&gt;seq_num;
<a name="l00256"></a>00256           
<a name="l00257"></a>00257           <a class="code" href="rn-extern_8h.html#5b99d884fbe86665c417897138aff8a6">rn_timer_reset</a>(lp, &amp;(SV-&gt;timer), tw_now(lp) + SV-&gt;rto);
<a name="l00258"></a>00258                   
<a name="l00259"></a>00259           <span class="keywordflow">if</span>(SV-&gt;timer) 
<a name="l00260"></a>00260             m1-&gt;seq_num = SV-&gt;unack;
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262       }
<a name="l00263"></a>00263 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Jan 27 09:38:30 2009 for ROSS.Net by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
