<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ip-layer.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>ip-layer.c</h1><a href="ip-layer_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;<a class="code" href="layer_2ip-layer_8h.html">ip-layer.h</a>&gt;</span>
00002 
00003 <span class="comment">/*</span>
00004 <span class="comment"> * Initializes a host and send appropriate messages</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This function simply zeros out the host state and then</span>
00007 <span class="comment"> * inits some simple values.</span>
00008 <span class="comment"> */</span>
00009 
00010 <span class="keywordtype">void</span>
<a name="l00011"></a><a class="code" href="ip-layer_8c.html#a0">00011</a> <a class="code" href="layer_2ip-layer_8c.html#a0">ip_layer_init</a>(ip_layer_state * state, tw_lp * lp)
00012 {
00013   state-&gt;host = <a class="code" href="rn-machine_8c.html#a0">rn_getmachine</a>(lp-&gt;id);
00014   state-&gt;next_hop = tw_getlp(state-&gt;host-&gt;link-&gt;addr);
00015 }
00016 
00017 
00018 <span class="keywordtype">void</span>
<a name="l00019"></a><a class="code" href="ip-layer_8c.html#a1">00019</a> <a class="code" href="layer_2ip-layer_8c.html#a1">ip_layer_event_handler</a>(ip_layer_state *state, tw_bf * bf, rn_message * msg, tw_lp * lp)
00020 {
00021   tw_stime        ts = 0;
00022 
00023   ip_layer_message *ip_m;
00024   rn_message       *r;
00025   tw_event         *n_evt;
00026   rn_link          *link;
00027   
00028   <span class="keywordflow">switch</span> (msg-&gt;type)
00029     {
00030     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00031       msg-&gt;size -= g_ip_header;
00032       
00033       <span class="keywordflow">return</span>;
00034       
00035     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00036       link = state-&gt;host-&gt;link;
00037       ip_m = rn_message_data_correct(msg, lp);
00038       ip_m-&gt;rc_lastsent = state-&gt;lastsent;
00039 
00040       <span class="keywordflow">if</span> (tw_now(lp) &gt; state-&gt;lastsent)
00041         state-&gt;lastsent = tw_now(lp);
00042       <span class="keywordflow">else</span>
00043         ts = state-&gt;lastsent - tw_now(lp);
00044             
00045       <span class="comment">// should add frequency</span>
00046       <span class="comment">// get next_hop</span>
00047       
00048       msg-&gt;size += g_ip_header;
00049       ts += (msg-&gt;size * 8 / (double) link-&gt;bandwidth  + link-&gt;delay);
00050       state-&gt;lastsent += (msg-&gt;size * 8/ (double) link-&gt;bandwidth );
00051       
00052 
00053       <span class="comment">// look at rn-event.c  for the correct way.     </span>
00054       n_evt = <a class="code" href="rn-event_8c.html#a1">rn_event_new</a>(state-&gt;next_hop , ts , lp, msg-&gt;size);
00055      
00056       r = <a class="code" href="rn-event_8c.html#a2">rn_event_data</a>(n_evt);
00057       <a class="code" href="rn-message_8c.html#a3">rn_message_setdirection</a>(r,<a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>);
00058       memcpy(r, msg,g_message_size);
00059       n_evt-&gt;dest_lp = tw_getlp(state-&gt;next_hop-&gt;id);
00060       <span class="keywordflow">if</span>(n_evt-&gt;dest_lp-&gt;id != state-&gt;next_hop-&gt;id)
00061         printf(<span class="stringliteral">"part of the problem is found\n"</span>);
00062       n_evt-&gt;message-&gt;dest_lp = state-&gt;next_hop-&gt;id;
00063       <a class="code" href="rn-event_8c.html#a3">rn_event_send</a>(n_evt);
00064       <span class="keywordflow">break</span>;
00065     <span class="keywordflow">default</span>:
00066       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d %f\n"</span>,
00067                msg-&gt;type, tw_now(lp));
00068     }
00069 }
00070 
00071 
00072 
00073 <span class="keywordtype">void</span>
<a name="l00074"></a><a class="code" href="ip-layer_8c.html#a2">00074</a> <a class="code" href="layer_2ip-layer_8c.html#a2">ip_layer_rc_event_handler</a>(ip_layer_state *state, tw_bf * bf, rn_message * msg, tw_lp * lp)
00075 {
00076   ip_layer_message *ip_m;
00077   
00078   <span class="keywordflow">switch</span> (msg-&gt;type)
00079     {
00080     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00081       msg-&gt;size += g_ip_header;
00082       <span class="keywordflow">return</span>;
00083       
00084     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00085       ip_m = <a class="code" href="rn-message_8c.html#a2">rn_message_data</a>(msg);
00086       state-&gt;lastsent = ip_m-&gt;rc_lastsent;
00087       <span class="keywordflow">break</span>;
00088 
00089     <span class="keywordflow">default</span>:
00090       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d\n"</span>,
00091                msg-&gt;type);
00092     }
00093 }
00094 
00095 <span class="keywordtype">void</span>
<a name="l00096"></a><a class="code" href="ip-layer_8c.html#a3">00096</a> <a class="code" href="layer_2ip-layer_8c.html#a3">ip_layer_final</a>(ip_layer_state *state, tw_lp * lp)
00097 {
00098 
00099 }
00100 
00101 <span class="keywordtype">void</span>
<a name="l00102"></a><a class="code" href="ip-layer_8c.html#a4">00102</a> <a class="code" href="layer_2ip-layer_8c.html#a4">ip_layer_xml</a>(tw_lp *lp)
00103 {
00104         xmlXPathObjectPtr       obj;
00105         xmlNodePtr              node;
00106         xmlNodePtr              layer;
00107         
00108         <span class="keywordtype">char</span>                    expr[30];
00109 
00110         <span class="comment">//tw_mutex_lock(&amp;g_tw_debug_lck);</span>
00111 
00112         ctxt = xmlXPathNewContext(document);
00113         ctxt-&gt;node = xmlDocGetRootElement(document);
00114 
00115         <span class="comment">/* This expression gets the node with our lp id */</span>
00116         sprintf(expr, <span class="stringliteral">"//node[@id=\'%d\']"</span>, lp-&gt;id);
00117 
00118         obj = <a class="code" href="xml-libxml_8c.html#a3">xpath</a>(expr);
00119         node = *obj-&gt;nodesetval-&gt;nodeTab;
00120 
00121         layer = node-&gt;children;
00122         <span class="keywordflow">while</span>(layer)
00123         {
00124                 <span class="keywordflow">if</span>(0 != strcmp(layer-&gt;name, <span class="stringliteral">"layer"</span>))
00125                 {
00126                         layer = layer-&gt;next;
00127                         <span class="keywordflow">continue</span>;
00128                 }
00129 
00130                 <span class="keywordflow">if</span>(strcmp(<a class="code" href="xml-libxml_8c.html#a7">xml_getprop</a>(layer, <span class="stringliteral">"name"</span>), <span class="stringliteral">"ip"</span>) == 0)
00131                 {
00132                         tw_lp_settype(lp, IP_LAYER_LP_TYPE);
00133                         printf(<span class="stringliteral">"Setting LP %d to IP! \n"</span>, lp-&gt;id);
00134                 }
00135 
00136                 <span class="keywordflow">if</span>(layer == node-&gt;last)
00137                         <span class="keywordflow">break</span>;
00138                 <span class="keywordflow">else</span>
00139                         layer = layer-&gt;next;
00140         }
00141         xmlXPathFreeObject(obj);
00142 }
00143 
</pre></div><hr><address style="align: right;"><small>Generated on Tue Apr 12 17:46:13 2005 for ROSS.Net by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
