<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ROSS.Net: rn-setup.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>rn-setup.c</h1><a href="rn-setup_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;<a class="code" href="rossnet_8h.html">rossnet.h</a>&gt;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="keywordtype">void</span>
<a name="l00004"></a><a class="code" href="rn-setup_8c.html#6f18e6f0a4738c20acc5f426426f7c2e">00004</a> <a class="code" href="rn-setup_8c.html#6f18e6f0a4738c20acc5f426426f7c2e">rn_setup_layers</a>(rn_lp_state * state, <span class="keywordtype">int</span> cur_stream, rn_layer * layer, 
<a name="l00005"></a>00005                 rn_lptype * types, xmlNodePtr x_layer, tw_lp * me)
<a name="l00006"></a>00006 {
<a name="l00007"></a>00007         xmlNodePtr               layer_xml;
<a name="l00008"></a>00008         rn_lptype               *t;
<a name="l00009"></a>00009         rn_lptype               *type_set = NULL;
<a name="l00010"></a>00010 
<a name="l00011"></a>00011         tw_lp                   *layer_lp;
<a name="l00012"></a>00012 
<a name="l00013"></a>00013         <span class="keywordtype">int</span>                      i;
<a name="l00014"></a>00014 
<a name="l00015"></a>00015         <span class="comment">/* </span>
<a name="l00016"></a>00016 <span class="comment">         * Got the XML for the layer, now setup layer, create LP state,</span>
<a name="l00017"></a>00017 <span class="comment">         * and call layer XML, INIT functions</span>
<a name="l00018"></a>00018 <span class="comment">         */</span>
<a name="l00019"></a>00019         layer_lp = &amp;layer-&gt;lp;
<a name="l00020"></a>00020         layer_lp-&gt;id = me-&gt;id;
<a name="l00021"></a>00021         layer_lp-&gt;pe = me-&gt;pe;
<a name="l00022"></a>00022         layer_lp-&gt;kp = me-&gt;kp;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024         layer_lp-&gt;state_qh = NULL;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026         <span class="keywordflow">for</span>(t = types, i = 0; t &amp;&amp; t-&gt;init; t = &amp;types[++i])
<a name="l00027"></a>00027         {
<a name="l00028"></a>00028                 <span class="keywordflow">if</span>(strcmp(<a class="code" href="rn-extern_8h.html#7a1c29f5a0e60ab08e5593acf5a463ba">xml_getprop</a>(x_layer, <span class="stringliteral">"name"</span>), t-&gt;sname) == 0)
<a name="l00029"></a>00029                 {
<a name="l00030"></a>00030                         <span class="comment">//tw_lp_settype(layer_lp, t-&gt;name);</span>
<a name="l00031"></a>00031                         memcpy(&amp;layer_lp-&gt;type, &amp;t-&gt;init, <span class="keyword">sizeof</span>(tw_lptype));
<a name="l00032"></a>00032                         type_set = <a class="code" href="rn-extern_8h.html#7268bf89295ecff51e980a86a850a23c">rn_lp_gettype</a>(layer_lp);
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#if RN_VERIFY_SETUP</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>                        printf(<span class="stringliteral">"\t\ttype: %s\n"</span>, t-&gt;sname);
<a name="l00036"></a>00036 <span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>                        <span class="keywordflow">break</span>;
<a name="l00038"></a>00038                 }
<a name="l00039"></a>00039         }
<a name="l00040"></a>00040 
<a name="l00041"></a>00041         <span class="keywordflow">if</span>(NULL == type_set)
<a name="l00042"></a>00042                 tw_error(TW_LOC, <span class="stringliteral">"No type for LP %d, layer: %s \n"</span>, 
<a name="l00043"></a>00043                                 me-&gt;id, <a class="code" href="rn-extern_8h.html#7a1c29f5a0e60ab08e5593acf5a463ba">xml_getprop</a>(x_layer, <span class="stringliteral">"name"</span>));
<a name="l00044"></a>00044 
<a name="l00045"></a>00045         tw_state_alloc(layer_lp, 1);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">/*</span>
<a name="l00048"></a>00048 <span class="comment">        layer_lp-&gt;cur_state = layer_lp-&gt;state_qh;</span>
<a name="l00049"></a>00049 <span class="comment">        layer_lp-&gt;state_qh = layer_lp-&gt;state_qh-&gt;next;</span>
<a name="l00050"></a>00050 <span class="comment">*/</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052         layer_xml = x_layer;
<a name="l00053"></a>00053         x_layer = x_layer-&gt;next;
<a name="l00054"></a>00054         <span class="keywordflow">while</span>(x_layer &amp;&amp; 0 != strcmp((<span class="keywordtype">char</span> *) x_layer-&gt;name, <span class="stringliteral">"layer"</span>))
<a name="l00055"></a>00055                 x_layer = x_layer-&gt;next;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#if RN_VERIFY_SETUP</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>        printf(<span class="stringliteral">"\t\tinit: %ld - %s\n"</span>, 
<a name="l00059"></a>00059                         (<span class="keywordtype">long</span> <span class="keywordtype">int</span>) layer, t-&gt;sname);
<a name="l00060"></a>00060 <span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a>00062         <span class="keywordflow">if</span>(x_layer)
<a name="l00063"></a>00063                 <a class="code" href="rn-setup_8c.html#6f18e6f0a4738c20acc5f426426f7c2e">rn_setup_layers</a>(state, cur_stream, ++layer, types, x_layer, me);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         state-&gt;cur_lp = layer_lp;
<a name="l00066"></a>00066         state-&gt;cur_stream = cur_stream;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         <span class="comment">/*</span>
<a name="l00069"></a>00069 <span class="comment">         * Layer LP XML function call</span>
<a name="l00070"></a>00070 <span class="comment">         */</span>
<a name="l00071"></a>00071         <span class="keywordflow">if</span>(type_set-&gt;xml_init)
<a name="l00072"></a>00072                 (*(<a class="code" href="rn-types_8h.html#93829a4f6710e130a1432452cf399ed1">rn_xml_init_f</a>) type_set-&gt;xml_init) (layer_lp-&gt;cur_state, layer_xml, layer_lp);
<a name="l00073"></a>00073         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != t-&gt;xml_init)
<a name="l00074"></a>00074                 tw_error(TW_LOC, <span class="stringliteral">"No XML function for lp %d!\n"</span>, me-&gt;id);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00080"></a>00080 <span class="keywordtype">void</span>
<a name="l00081"></a><a class="code" href="rn-setup_8c.html#a5d6cfc1c375989af881be30c9954912">00081</a> <a class="code" href="rn-extern_8h.html#a5d6cfc1c375989af881be30c9954912">rn_setup_streams</a>(rn_lp_state * state, rn_lptype * types, tw_lp * lp)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083         xmlNodePtr              node;
<a name="l00084"></a>00084         xmlNodePtr              x_temp;
<a name="l00085"></a>00085         xmlNodePtr              x_stream;
<a name="l00086"></a>00086         xmlNodePtr              x_layer;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         <span class="keywordtype">int</span>                     cur_stream;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         rn_layer                *layer;
<a name="l00091"></a>00091         rn_stream               *stream;
<a name="l00092"></a>00092         rn_machine              *m;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         m = <a class="code" href="rn-extern_8h.html#b586ebafc20ad652dd538635f5c816b0">rn_getmachine</a>(lp-&gt;id);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#if RN_VERIFY_SETUP</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>        printf(<span class="stringliteral">"SETUP star model for node: %lld \n"</span>, lp-&gt;gid);
<a name="l00098"></a>00098 <span class="preprocessor">#endif</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a>00100         <span class="keywordflow">for</span>(x_stream = m-&gt;xml-&gt;children; x_stream; x_stream = x_stream-&gt;next)
<a name="l00101"></a>00101         {
<a name="l00102"></a>00102                 <span class="keywordflow">if</span>(0 != strcmp((<span class="keywordtype">char</span> *) x_stream-&gt;name, <span class="stringliteral">"stream"</span>))
<a name="l00103"></a>00103                         <span class="keywordflow">continue</span>;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105                 state-&gt;nstreams++;
<a name="l00106"></a>00106         }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         state-&gt;streams = <a class="code" href="rn-extern_8h.html#bbe79ef704989690d5d0c23371396de9">rn_stream_alloc</a>(state-&gt;nstreams);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keywordflow">if</span>(!state-&gt;streams)
<a name="l00111"></a>00111                 tw_error(TW_LOC, <span class="stringliteral">"Did not get any streams for machine %d!"</span>, lp-&gt;id);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         node = m-&gt;xml;
<a name="l00114"></a>00114         stream = state-&gt;streams;
<a name="l00115"></a>00115         cur_stream = 0;
<a name="l00116"></a>00116         <span class="keywordflow">for</span>(x_stream = node-&gt;children; x_stream; x_stream = x_stream-&gt;next)
<a name="l00117"></a>00117         {
<a name="l00118"></a>00118                 <span class="keywordflow">if</span>(0 != strcmp((<span class="keywordtype">char</span> *) x_stream-&gt;name, <span class="stringliteral">"stream"</span>))
<a name="l00119"></a>00119                         <span class="keywordflow">continue</span>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121                 stream-&gt;port = atoi(<a class="code" href="rn-extern_8h.html#7a1c29f5a0e60ab08e5593acf5a463ba">xml_getprop</a>(x_stream, <span class="stringliteral">"port"</span>));
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="preprocessor">#if RN_VERIFY_SETUP</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>                printf(<span class="stringliteral">"\tport: %d \n"</span>, stream-&gt;port);
<a name="l00125"></a>00125 <span class="preprocessor">#endif</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>
<a name="l00127"></a>00127                 <span class="comment">/*</span>
<a name="l00128"></a>00128 <span class="comment">                 * Setup the stream layers</span>
<a name="l00129"></a>00129 <span class="comment">                 */</span>
<a name="l00130"></a>00130                 <span class="keywordflow">for</span>(x_temp = x_stream-&gt;children; x_temp; x_temp = x_temp-&gt;next)
<a name="l00131"></a>00131                 {
<a name="l00132"></a>00132                         <span class="keywordflow">if</span>(0 != strcmp((<span class="keywordtype">char</span> *) x_temp-&gt;name, <span class="stringliteral">"layer"</span>))
<a name="l00133"></a>00133                                 <span class="keywordflow">continue</span>;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135                         stream-&gt;nlayers++;
<a name="l00136"></a>00136                 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138                 stream-&gt;layers = <a class="code" href="rn-extern_8h.html#b0a7da4becc0ae7d53909eea87a8316a">rn_layer_alloc</a>(stream-&gt;nlayers);
<a name="l00139"></a>00139                 layer = stream-&gt;layers;
<a name="l00140"></a>00140                 x_layer = x_stream-&gt;children;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">#if RN_VERIFY_SETUP</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>                printf(<span class="stringliteral">"\tlayers: %d\n"</span>, stream-&gt;nlayers);
<a name="l00144"></a>00144 <span class="preprocessor">#endif</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146                 <span class="keywordflow">while</span>(0 != strcmp((<span class="keywordtype">char</span> *) x_layer-&gt;name, <span class="stringliteral">"layer"</span>))
<a name="l00147"></a>00147                         x_layer = x_layer-&gt;next;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149                 <a class="code" href="rn-setup_8c.html#6f18e6f0a4738c20acc5f426426f7c2e">rn_setup_layers</a>(state, cur_stream, layer, types, x_layer, lp);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151                 stream = stream + 1;
<a name="l00152"></a>00152                 cur_stream++;
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         m-&gt;xml = NULL;
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">/*</span>
<a name="l00159"></a>00159 <span class="comment"> * This function should handle the link status changes</span>
<a name="l00160"></a>00160 <span class="comment"> * that occur by sending a link status change event for each link on</span>
<a name="l00161"></a>00161 <span class="comment"> * this LP which is going to change.</span>
<a name="l00162"></a>00162 <span class="comment"> */</span>
<a name="l00163"></a>00163 <span class="keywordtype">void</span>
<a name="l00164"></a><a class="code" href="rn-setup_8c.html#cbcbdbead7a3d0ebc4e17aab58cc204b">00164</a> <a class="code" href="rn-extern_8h.html#cbcbdbead7a3d0ebc4e17aab58cc204b">rn_setup_links</a>(rn_lp_state * state, tw_lp * lp)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166 <span class="preprocessor">#if DYNAMIC_LINKS</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>        tw_event        *e;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         rn_message      *msg;
<a name="l00170"></a>00170         rn_machine      *m;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <span class="keywordtype">int</span>              i;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         m = <a class="code" href="rn-extern_8h.html#b586ebafc20ad652dd538635f5c816b0">rn_getmachine</a>(lp-&gt;id);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="keywordflow">for</span>(i = 0; i &lt; m-&gt;nlinks; i++)
<a name="l00177"></a>00177         {
<a name="l00178"></a>00178                 <span class="keywordflow">if</span>(m-&gt;link[i].next_status == 0 || m-&gt;link[i].next_status == INT_MAX)
<a name="l00179"></a>00179                         <span class="keywordflow">continue</span>;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="preprocessor">#if 1</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>                printf(<span class="stringliteral">"%lld: Setting link status event for time %lf, now %lf \n"</span>, 
<a name="l00183"></a>00183                                 lp-&gt;gid, m-&gt;link[i].next_status, tw_now(lp));
<a name="l00184"></a>00184 <span class="preprocessor">#endif</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>
<a name="l00186"></a>00186                 <a class="code" href="rn-extern_8h.html#f19835b74f981f1e98a215a488aa0342">g_rn_nlink_status</a>++;
<a name="l00187"></a>00187                 e = tw_event_new(lp, m-&gt;link[i].next_status, lp);
<a name="l00188"></a>00188                 msg = tw_event_data(e);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190                 msg-&gt;port = i;
<a name="l00191"></a>00191                 msg-&gt;src = lp-&gt;id;
<a name="l00192"></a>00192                 msg-&gt;dst = lp-&gt;id;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194                 <span class="keywordflow">if</span>(m-&gt;link[i].status == <a class="code" href="rn-types_8h.html#2d0a8ea9d30165ab589bd3431b19a809e6ca115d8025eff150e273e71d7c090e">rn_link_up</a>)
<a name="l00195"></a>00195                         msg-&gt;type = <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef020abef14eb10a694d7e18fd9c09972eb9">LINK_STATUS_DOWN</a>;
<a name="l00196"></a>00196                 <span class="keywordflow">else</span>
<a name="l00197"></a>00197                         msg-&gt;type = <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef0290f726b46437670cde3c6c1a3a54d467">LINK_STATUS_UP</a>;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 tw_event_send(e);
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201 <span class="preprocessor">#endif</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>}
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="keywordtype">void</span>
<a name="l00205"></a><a class="code" href="rn-setup_8c.html#8ea9cf6038e94e113986cd8cd058090e">00205</a> <a class="code" href="rn-extern_8h.html#8ea9cf6038e94e113986cd8cd058090e">rn_setup</a>()
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207         <span class="keywordflow">if</span>(0 != strcmp(<a class="code" href="rn-extern_8h.html#7199204689d83ed6e37695c3baaa2f85">g_rn_tools_dir</a>, <span class="stringliteral">""</span>))
<a name="l00208"></a>00208         {
<a name="l00209"></a>00209                 <span class="keywordtype">char</span> * dir = <a class="code" href="rn-extern_8h.html#7199204689d83ed6e37695c3baaa2f85">g_rn_tools_dir</a>;
<a name="l00210"></a>00210                 sprintf(<a class="code" href="rn-extern_8h.html#6116080aae51cd236a5e93bae46780f1">g_rn_xml_topology</a>, <span class="stringliteral">"tools/%s/%s.xml"</span>, dir, dir);
<a name="l00211"></a>00211                 sprintf(<a class="code" href="rn-extern_8h.html#e26a2f6ed0f9caa31e7f5809a42e90c0">g_rn_rt_table</a>, <span class="stringliteral">"tools/%s/%s.rt"</span>, dir, dir);
<a name="l00212"></a>00212                 sprintf(<a class="code" href="rn-extern_8h.html#c3d4953961d8eb1c314de927cfe34d8c">g_rn_xml_link_topology</a>, <span class="stringliteral">"tools/%s/links.xml"</span>, dir);
<a name="l00213"></a>00213                 <span class="comment">//sprintf(g_rn_xml_model, "tools/%s/model.xml", dir);</span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                 printf(<span class="stringliteral">"Opening config file: %s \n"</span>, <a class="code" href="rn-extern_8h.html#6116080aae51cd236a5e93bae46780f1">g_rn_xml_topology</a>);
<a name="l00216"></a>00216                 printf(<span class="stringliteral">"Opening link file: %s \n"</span>, <a class="code" href="rn-extern_8h.html#c3d4953961d8eb1c314de927cfe34d8c">g_rn_xml_link_topology</a>);
<a name="l00217"></a>00217                 printf(<span class="stringliteral">"Opening routing table file: %s \n"</span>, <a class="code" href="rn-extern_8h.html#e26a2f6ed0f9caa31e7f5809a42e90c0">g_rn_rt_table</a>);
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Jan 27 09:38:29 2009 for ROSS.Net by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
