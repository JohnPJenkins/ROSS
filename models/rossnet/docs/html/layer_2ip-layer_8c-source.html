<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ip-layer.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>ip-layer.c</h1><a href="layer_2ip-layer_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;<a class="code" href="layer_2ip-layer_8h.html">ip-layer.h</a>&gt;</span>
00002 
00003 <span class="comment">/*</span>
00004 <span class="comment"> * Initializes a host and send appropriate messages</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This function simply zeros out the host state and then</span>
00007 <span class="comment"> * inits some simple values.</span>
00008 <span class="comment"> */</span>
00009 
00010 <span class="keywordtype">void</span>
<a name="l00011"></a><a class="code" href="layer_2ip-layer_8c.html#a0">00011</a> <a class="code" href="layer_2ip-layer_8c.html#a0">ip_layer_init</a>(ip_layer_state * state, xmlNodePtr node, tw_lp * lp)
00012 {
00013   state-&gt;host = <a class="code" href="rn-machine_8c.html#a0">rn_getmachine</a>(lp-&gt;id);
00014   state-&gt;next_hop = tw_getlp(state-&gt;host-&gt;link-&gt;addr);
00015 }
00016 
00017 
00018 <span class="keywordtype">void</span>
<a name="l00019"></a><a class="code" href="layer_2ip-layer_8c.html#a1">00019</a> <a class="code" href="layer_2ip-layer_8c.html#a1">ip_layer_event_handler</a>(ip_layer_state *state, tw_bf * bf, rn_message * msg, tw_lp * lp)
00020 {
00021   tw_stime        ts = 0;
00022 
00023   ip_layer_message *ip_m;
00024   rn_message       *r;
00025   tw_event         *n_evt;
00026   rn_link          *link;
00027   
00028   <span class="keywordflow">switch</span> (msg-&gt;type)
00029     {
00030     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00031       msg-&gt;size -= g_ip_header;
00032       
00033       <span class="keywordflow">return</span>;
00034       
00035     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00036       link = state-&gt;host-&gt;link;
00037       <span class="comment">//ip_m = rn_message_data_correct(msg, lp);</span>
00038         ip_m = <a class="code" href="rn-message_8c.html#a2">rn_message_data</a>(msg);
00039 
00040       ip_m-&gt;rc_lastsent = state-&gt;lastsent;
00041 
00042       <span class="keywordflow">if</span> (tw_now(lp) &gt; state-&gt;lastsent)
00043         state-&gt;lastsent = tw_now(lp);
00044       <span class="keywordflow">else</span>
00045         ts = state-&gt;lastsent - tw_now(lp);
00046             
00047       <span class="comment">// should add frequency</span>
00048       <span class="comment">// get next_hop</span>
00049       
00050       msg-&gt;size += g_ip_header;
00051       ts += (msg-&gt;size * 8 / (double) link-&gt;bandwidth  + link-&gt;delay);
00052       state-&gt;lastsent += (msg-&gt;size * 8/ (double) link-&gt;bandwidth );
00053       
00054 
00055       <span class="comment">// look at rn-event.c  for the correct way.     </span>
00056       n_evt = <a class="code" href="rn-event_8c.html#a1">rn_event_new</a>(state-&gt;next_hop, ts, lp, <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>, msg-&gt;size);
00057      
00058       r = <a class="code" href="rn-event_8c.html#a2">rn_event_data</a>(n_evt);
00059         ip_m = <a class="code" href="rn-message_8c.html#a2">rn_message_data</a>(r);
00060       memcpy(ip_m, msg, msg-&gt;size);
00061       n_evt-&gt;dest_lp = tw_getlp(state-&gt;next_hop-&gt;id);
00062       <span class="keywordflow">if</span>(n_evt-&gt;dest_lp-&gt;id != state-&gt;next_hop-&gt;id)
00063         printf(<span class="stringliteral">"part of the problem is found\n"</span>);
00064       n_evt-&gt;message-&gt;dest_lp = state-&gt;next_hop-&gt;id;
00065       <a class="code" href="rn-event_8c.html#a3">rn_event_send</a>(n_evt);
00066       <span class="keywordflow">break</span>;
00067     <span class="keywordflow">default</span>:
00068       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d %f\n"</span>,
00069                msg-&gt;type, tw_now(lp));
00070     }
00071 }
00072 
00073 
00074 
00075 <span class="keywordtype">void</span>
<a name="l00076"></a><a class="code" href="layer_2ip-layer_8c.html#a2">00076</a> <a class="code" href="layer_2ip-layer_8c.html#a2">ip_layer_rc_event_handler</a>(ip_layer_state *state, tw_bf * bf, rn_message * msg, tw_lp * lp)
00077 {
00078   ip_layer_message *ip_m;
00079   
00080   <span class="keywordflow">switch</span> (msg-&gt;type)
00081     {
00082     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a13">UPSTREAM</a>:
00083       msg-&gt;size += g_ip_header;
00084       <span class="keywordflow">return</span>;
00085       
00086     <span class="keywordflow">case</span> <a class="code" href="rn-types_8h.html#a25a11">DOWNSTREAM</a>:
00087       ip_m = <a class="code" href="rn-message_8c.html#a2">rn_message_data</a>(msg);
00088       state-&gt;lastsent = ip_m-&gt;rc_lastsent;
00089       <span class="keywordflow">break</span>;
00090 
00091     <span class="keywordflow">default</span>:
00092       tw_error(TW_LOC, <span class="stringliteral">"IP-LAYER, ip_layer_event_handler, Unkown message type %d\n"</span>,
00093                msg-&gt;type);
00094     }
00095 }
00096 
00097 <span class="keywordtype">void</span>
<a name="l00098"></a><a class="code" href="layer_2ip-layer_8c.html#a3">00098</a> <a class="code" href="layer_2ip-layer_8c.html#a3">ip_layer_final</a>(ip_layer_state *state, tw_lp * lp)
00099 {
00100 
00101 }
00102 
00103 <span class="keywordtype">void</span>
<a name="l00104"></a><a class="code" href="layer_2ip-layer_8c.html#a4">00104</a> <a class="code" href="layer_2ip-layer_8c.html#a4">ip_layer_xml</a>(tw_lp *lp, xmlNodePtr node)
00105 {
00106         xmlNodePtr              layer;
00107         
00108         <span class="keywordflow">for</span>(layer = node; layer; layer = layer-&gt;next)
00109         {
00110                 <span class="keywordflow">if</span>(0 != strcmp(layer-&gt;name, <span class="stringliteral">"layer"</span>))
00111                         <span class="keywordflow">continue</span>;
00112 
00113                 <span class="keywordflow">if</span>(strcmp(<a class="code" href="xml-libxml_8c.html#a7">xml_getprop</a>(layer, <span class="stringliteral">"name"</span>), <span class="stringliteral">"ip"</span>) == 0)
00114                 {
00115                         tw_lp_settype(lp, IP_LAYER_LP_TYPE);
00116                         printf(<span class="stringliteral">"Setting LP %d to IP! \n"</span>, lp-&gt;id);
00117 
00118                         <span class="keywordflow">break</span>;
00119                 }
00120         }
00121 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Apr 12 17:46:13 2005 for ROSS.Net by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
