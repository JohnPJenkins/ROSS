<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ROSS.Net: rn-event.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>rn-event.c File Reference</h1>
<p>
<code>#include &lt;<a class="el" href="rossnet_8h-source.html">rossnet.h</a>&gt;</code><br>

<p>
<a href="rn-event_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">tw_event *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rn-event_8c.html#54cc9a421610941e3b0ce5a3ce5e134c">rn_event_direct</a> (tw_lpid dst, tw_stime ts, tw_lp *src)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">tw_event *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rn-event_8c.html#5508bcf53c1fbeb71e6055021634a726">rn_event_new</a> (tw_lpid dst, tw_stime ts, tw_lp *src, <a class="el" href="rn-types_8h.html#cd6ee16a232957f10b11c99c7ea957a2">rn_message_type</a> dir, unsigned long int size)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rn-event_8c.html#3a6eb517cf4b083af531872ed92d4872">rn_event_data</a> (tw_event *e)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rn-event_8c.html#8c3496e774b118a7e411ea5bcd23d49a">rn_event_send</a> (tw_event *new_event)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="3a6eb517cf4b083af531872ed92d4872"></a><!-- doxytag: member="rn-event.c::rn_event_data" ref="3a6eb517cf4b083af531872ed92d4872" args="(tw_event *e)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* rn_event_data           </td>
          <td>(</td>
          <td class="paramtype">tw_event *&nbsp;</td>
          <td class="paramname"> <em>e</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rn-event_8c-source.html#l00167">167</a> of file <a class="el" href="rn-event_8c-source.html">rn-event.c</a>.</p>

<p>References <a class="el" href="rn-message_8c-source.html#l00016">rn_message_data()</a>.</p>

<p>Referenced by <a class="el" href="ftp_8c-source.html#l00034">ftp_event_handler()</a>, <a class="el" href="ospf-ip_8c-source.html#l00005">ospf_ip_route()</a>, and <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00168"></a>00168 {
<a name="l00169"></a>00169         <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *) <a class="code" href="rn-extern_8h.html#86476e44643558d9a2008c976220a0a3">rn_message_data</a>((rn_message *) tw_event_data(e));
<a name="l00170"></a>00170 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="54cc9a421610941e3b0ce5a3ce5e134c"></a><!-- doxytag: member="rn-event.c::rn_event_direct" ref="54cc9a421610941e3b0ce5a3ce5e134c" args="(tw_lpid dst, tw_stime ts, tw_lp *src)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">tw_event* rn_event_direct           </td>
          <td>(</td>
          <td class="paramtype">tw_lpid&nbsp;</td>
          <td class="paramname"> <em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_stime&nbsp;</td>
          <td class="paramname"> <em>ts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>src</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rn-event_8c-source.html#l00008">8</a> of file <a class="el" href="rn-event_8c-source.html">rn-event.c</a>.</p>

<p>References <a class="el" href="rn-types_8h-source.html#l00058">DIRECT</a>, <a class="el" href="rn-stream_8c-source.html#l00023">rn_getstream()</a>, and <a class="el" href="ospf-global_8c-source.html#l00030">s</a>.</p>

<p>Referenced by <a class="el" href="epi-agent_8c-source.html#l00195">epi_agent_remove()</a>, <a class="el" href="epi-num_8c-source.html#l00021">epi_num_add()</a>, <a class="el" href="epi-num_8c-source.html#l00004">epi_num_check_report()</a>, and <a class="el" href="epi-num_8c-source.html#l00063">epi_num_remove()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00009"></a>00009 {
<a name="l00010"></a>00010         tw_event        *e;
<a name="l00011"></a>00011 
<a name="l00012"></a>00012         rn_lp_state     *state;
<a name="l00013"></a>00013         rn_stream       *<a class="code" href="ospf-extern_8h.html#b4c6c03359486e6fb0ac52a94493df1e">s</a>;
<a name="l00014"></a>00014         rn_message      *m;
<a name="l00015"></a>00015 
<a name="l00016"></a>00016         state = src-&gt;cur_state;
<a name="l00017"></a>00017         s = <a class="code" href="rn-extern_8h.html#af86a65184f40426de1361196ef45cef">rn_getstream</a>(src);
<a name="l00018"></a>00018 
<a name="l00019"></a>00019         e = tw_event_new(dst, ts, src);
<a name="l00020"></a>00020         m = tw_event_data(e);
<a name="l00021"></a>00021 
<a name="l00022"></a>00022         m-&gt;type = <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef021ea328a644e627283a35716a54108248">DIRECT</a>;
<a name="l00023"></a>00023         m-&gt;timer = state-&gt;cur_lp;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025         m-&gt;size = s-&gt;cur_layer;
<a name="l00026"></a>00026         m-&gt;port = s-&gt;port;
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         m-&gt;src = src-&gt;id;
<a name="l00029"></a>00029         m-&gt;dst = dst;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031         <span class="keywordflow">return</span> e;
<a name="l00032"></a>00032 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5508bcf53c1fbeb71e6055021634a726"></a><!-- doxytag: member="rn-event.c::rn_event_new" ref="5508bcf53c1fbeb71e6055021634a726" args="(tw_lpid dst, tw_stime ts, tw_lp *src, rn_message_type dir, unsigned long int size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">tw_event* rn_event_new           </td>
          <td>(</td>
          <td class="paramtype">tw_lpid&nbsp;</td>
          <td class="paramname"> <em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_stime&nbsp;</td>
          <td class="paramname"> <em>ts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tw_lp *&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="rn-types_8h.html#cd6ee16a232957f10b11c99c7ea957a2">rn_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long int&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
inter-lp: events which will be sent to a remote lp<p>
inter-lp events are handled as usual<p>
intra-lp: events which are sent to another layer on the same lp<p>
intra-lp events are immediately scheduled and processed, because their destination is the local machine, and have a zero timestamp offset, which means the following:<p>
the next layer is responsible for handling packet data, ie, from TCP to IP. The IP layer must re-create the TCP packect on the dest LP.<p>
abort events: should not let them traverse layers.. first layer to get abort is then the only one to get rolled back<p>
NOTE: We should probably base the timestamp off of the network characteristics, rather than make the model do it. When the model calls this function, and is the last layer, we should know the proper link to use, and can inform the model if this event will fail if sent, over the network. 
<p>Definition at line <a class="el" href="rn-event_8c-source.html#l00058">58</a> of file <a class="el" href="rn-event_8c-source.html">rn-event.c</a>.</p>

<p>References <a class="el" href="rn-types_8h-source.html#l00055">DOWNSTREAM</a>, <a class="el" href="rn-global_8c-source.html#l00015">g_rn_ttl</a>, <a class="el" href="rn-machine_8c-source.html#l00004">rn_getmachine()</a>, <a class="el" href="rn-stream_8c-source.html#l00023">rn_getstream()</a>, <a class="el" href="rn-types_8h-source.html#l00068">rn_link_down</a>, <a class="el" href="rn-link_8c-source.html#l00033">rn_link_getstatus()</a>, <a class="el" href="ospf-global_8c-source.html#l00030">s</a>, and <a class="el" href="rn-types_8h-source.html#l00057">UPSTREAM</a>.</p>

<p>Referenced by <a class="el" href="bgp-connect_8c-source.html#l00013">bgp_connect()</a>, <a class="el" href="bgp-keepalive_8c-source.html#l00020">bgp_keepalive_send()</a>, <a class="el" href="bgp-keepalive_8c-source.html#l00113">bgp_keepalive_timer()</a>, <a class="el" href="bgp-notify_8c-source.html#l00004">bgp_notify_send()</a>, <a class="el" href="bgp-open_8c-source.html#l00004">bgp_open_send()</a>, <a class="el" href="bgp-update_8c-source.html#l00007">bgp_update_send()</a>, <a class="el" href="ip-downstream_8c-source.html#l00032">forward()</a>, <a class="el" href="ftp_8c-source.html#l00034">ftp_event_handler()</a>, <a class="el" href="ftp_8c-source.html#l00007">ftp_init()</a>, <a class="el" href="ip-packet_8c-source.html#l00004">ip_packet_drop()</a>, <a class="el" href="ip-upstream_8c-source.html#l00004">ip_upstream()</a>, <a class="el" href="num-file_8c-source.html#l00008">num_file_start()</a>, <a class="el" href="num-file_8c-source.html#l00024">num_file_stop()</a>, <a class="el" href="ospf-util_8c-source.html#l00004">ospf_event_new()</a>, <a class="el" href="tcp-util_8c-source.html#l00004">tcp_event_send()</a>, <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>, <a class="el" href="tcp-process_8c-source.html#l00007">tcp_process_ack()</a>, and <a class="el" href="tcp-timeout_8c-source.html#l00004">tcp_timeout()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00060"></a>00060 {
<a name="l00061"></a>00061         tw_event        *e;
<a name="l00062"></a>00062         tw_stime         abs_ts = DBL_MAX;
<a name="l00063"></a>00063 
<a name="l00064"></a>00064         rn_lp_state     *state;
<a name="l00065"></a>00065         rn_message      *r;
<a name="l00066"></a>00066         rn_stream       *<a class="code" href="ospf-extern_8h.html#b4c6c03359486e6fb0ac52a94493df1e">s</a>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         rn_machine      *m;
<a name="l00069"></a>00069         <span class="comment">//rn_link               *l;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         state = src-&gt;cur_state;
<a name="l00072"></a>00072         s = <a class="code" href="rn-extern_8h.html#af86a65184f40426de1361196ef45cef">rn_getstream</a>(src);
<a name="l00073"></a>00073         m = <a class="code" href="rn-extern_8h.html#b586ebafc20ad652dd538635f5c816b0">rn_getmachine</a>(src-&gt;id);
<a name="l00074"></a>00074         <span class="comment">//l = rn_getlink(m, dst-&gt;id);</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="comment">// if model attempts to send upstream event, and is </span>
<a name="l00077"></a>00077         <span class="comment">// top-most layer, abort processing</span>
<a name="l00078"></a>00078         <span class="keywordflow">if</span>(dir == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a> &amp;&amp; !s-&gt;cur_layer)
<a name="l00079"></a>00079                 <span class="keywordflow">return</span> src-&gt;pe-&gt;abort_event;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="comment">// Check for layer switching directions on us..</span>
<a name="l00082"></a>00082         <span class="keywordflow">if</span>(state-&gt;cev)
<a name="l00083"></a>00083         {
<a name="l00084"></a>00084                 r = tw_event_data(state-&gt;cev);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086                 <span class="keywordflow">if</span>(r-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a> &amp;&amp; dir == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02193085e792a05c4538ec2bc24c845652">DOWNSTREAM</a>)
<a name="l00087"></a>00087                 {
<a name="l00088"></a>00088                         state-&gt;cev = NULL;
<a name="l00089"></a>00089                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(r-&gt;type != dir &amp;&amp; dir == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a>)
<a name="l00090"></a>00090                 {
<a name="l00091"></a>00091                         state-&gt;cev = src-&gt;pe-&gt;cur_event;
<a name="l00092"></a>00092                         abs_ts = state-&gt;cev-&gt;recv_ts + ts;
<a name="l00093"></a>00093                 }
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#if 0</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(l &amp;&amp; state-&gt;cev &amp;&amp; <a class="code" href="rn-types_8h.html#2d0a8ea9d30165ab589bd3431b19a80929bbbd97ec459362182b9056bd79054a">rn_link_down</a> == <a class="code" href="rn-extern_8h.html#6c557039fb9044b6a1674744fe3adb06">rn_link_getstatus</a>(l, abs_ts))
<a name="l00098"></a>00098         {
<a name="l00099"></a>00099                 e = src-&gt;pe-&gt;free_q-&gt;abort;
<a name="l00100"></a>00100                 e-&gt;src_lp = src;
<a name="l00101"></a>00101                 e-&gt;dest_lp = dst;
<a name="l00102"></a>00102                 e-&gt;recv_ts = tw_now(src) + ts;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                 r = tw_event_data(src-&gt;pe-&gt;free_q-&gt;abort);
<a name="l00105"></a>00105                 r-&gt;type = dir;
<a name="l00106"></a>00106                 r-&gt;src = src-&gt;id;
<a name="l00107"></a>00107                 r-&gt;dst = dst-&gt;id;
<a name="l00108"></a>00108                 r-&gt;size = size;
<a name="l00109"></a>00109                 r-&gt;port = s-&gt;port;
<a name="l00110"></a>00110                 r-&gt;timer = NULL;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>                printf(<span class="stringliteral">"%ld RN: new ABORT event %d, port %d \n"</span>, 
<a name="l00114"></a>00114                         src-&gt;id, (<span class="keywordtype">int</span>) e, r-&gt;port);
<a name="l00115"></a>00115 <span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a>00117                 <span class="keywordflow">return</span> e;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119 <span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121         <span class="keywordflow">if</span>(!state-&gt;cev)
<a name="l00122"></a>00122         {
<a name="l00123"></a>00123                 e = tw_event_new(dst, ts, src);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125                 state-&gt;cev = e;
<a name="l00126"></a>00126                 r = tw_event_data(e);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128                 r-&gt;type = dir;
<a name="l00129"></a>00129                 r-&gt;src = src-&gt;id;
<a name="l00130"></a>00130                 r-&gt;dst = dst;
<a name="l00131"></a>00131                 r-&gt;size = size;
<a name="l00132"></a>00132                 r-&gt;port = s-&gt;port;
<a name="l00133"></a>00133                 r-&gt;timer = NULL;
<a name="l00134"></a>00134                 r-&gt;ttl = <a class="code" href="rn-extern_8h.html#ac5ec8643078b9816be32d2eb0583bc7">g_rn_ttl</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>                printf(<span class="stringliteral">"%ld RN: Created new event %ld, port %d \n"</span>, 
<a name="l00138"></a>00138                         src-&gt;id, (<span class="keywordtype">long</span> <span class="keywordtype">int</span>) e, r-&gt;port);
<a name="l00139"></a>00139 <span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>        } <span class="keywordflow">else</span>
<a name="l00141"></a>00141         {
<a name="l00142"></a>00142                 e = state-&gt;cev;
<a name="l00143"></a>00143                 e-&gt;recv_ts += ts;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145                 r = tw_event_data(e);
<a name="l00146"></a>00146                 r-&gt;size = size;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148                 <span class="keywordflow">if</span>(e-&gt;recv_ts &gt; g_tw_ts_end)
<a name="l00149"></a>00149                         src-&gt;pe-&gt;cev_abort = 1;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151                 <span class="comment">//if((tw_lpid) e-&gt;dest_lp != dst)</span>
<a name="l00152"></a>00152                 <span class="keywordflow">if</span>(r-&gt;dst != dst)
<a name="l00153"></a>00153                 {
<a name="l00154"></a>00154 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>                        printf(<span class="stringliteral">"Redirecting event %ld: from %lld to %lld \n"</span>,
<a name="l00156"></a>00156                                 (<span class="keywordtype">long</span> <span class="keywordtype">int</span>) e, (tw_lpid) e-&gt;dest_lp, dst);
<a name="l00157"></a>00157 <span class="preprocessor">#endif</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>
<a name="l00159"></a>00159                         e-&gt;dest_lp = (tw_lp *) dst;
<a name="l00160"></a>00160                 }
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="keywordflow">return</span> e;
<a name="l00164"></a>00164 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8c3496e774b118a7e411ea5bcd23d49a"></a><!-- doxytag: member="rn-event.c::rn_event_send" ref="8c3496e774b118a7e411ea5bcd23d49a" args="(tw_event *new_event)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rn_event_send           </td>
          <td>(</td>
          <td class="paramtype">tw_event *&nbsp;</td>
          <td class="paramname"> <em>new_event</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rn-event_8c-source.html#l00173">173</a> of file <a class="el" href="rn-event_8c-source.html">rn-event.c</a>.</p>

<p>References <a class="el" href="rn-types_8h-source.html#l00045">c_host</a>, <a class="el" href="rn-types_8h-source.html#l00058">DIRECT</a>, <a class="el" href="rn-types_8h-source.html#l00055">DOWNSTREAM</a>, <a class="el" href="rn-machine_8c-source.html#l00004">rn_getmachine()</a>, <a class="el" href="rn-stream_8c-source.html#l00023">rn_getstream()</a>, <a class="el" href="rn-stream_8c-source.html#l00004">rn_getstream_byport()</a>, <a class="el" href="ospf-global_8c-source.html#l00030">s</a>, and <a class="el" href="rn-types_8h-source.html#l00057">UPSTREAM</a>.</p>

<p>Referenced by <a class="el" href="bgp-connect_8c-source.html#l00013">bgp_connect()</a>, <a class="el" href="bgp-keepalive_8c-source.html#l00020">bgp_keepalive_send()</a>, <a class="el" href="bgp-keepalive_8c-source.html#l00113">bgp_keepalive_timer()</a>, <a class="el" href="bgp-notify_8c-source.html#l00004">bgp_notify_send()</a>, <a class="el" href="bgp-open_8c-source.html#l00004">bgp_open_send()</a>, <a class="el" href="bgp-update_8c-source.html#l00007">bgp_update_send()</a>, <a class="el" href="epi-agent_8c-source.html#l00195">epi_agent_remove()</a>, <a class="el" href="epi-num_8c-source.html#l00021">epi_num_add()</a>, <a class="el" href="epi-num_8c-source.html#l00004">epi_num_check_report()</a>, <a class="el" href="epi-num_8c-source.html#l00063">epi_num_remove()</a>, <a class="el" href="ftp_8c-source.html#l00034">ftp_event_handler()</a>, <a class="el" href="ftp_8c-source.html#l00007">ftp_init()</a>, <a class="el" href="ip-downstream_8c-source.html#l00095">ip_downstream_forward()</a>, <a class="el" href="ip-downstream_8c-source.html#l00084">ip_downstream_source()</a>, <a class="el" href="ip-upstream_8c-source.html#l00004">ip_upstream()</a>, <a class="el" href="num-file_8c-source.html#l00008">num_file_start()</a>, <a class="el" href="num-file_8c-source.html#l00024">num_file_stop()</a>, <a class="el" href="ospf-util_8c-source.html#l00024">ospf_event_send()</a>, <a class="el" href="tcp-util_8c-source.html#l00004">tcp_event_send()</a>, <a class="el" href="tcp-layer-util_8c-source.html#l00008">tcp_layer_util_event()</a>, <a class="el" href="tcp-process_8c-source.html#l00007">tcp_process_ack()</a>, and <a class="el" href="tcp-timeout_8c-source.html#l00004">tcp_timeout()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00174"></a>00174 {
<a name="l00175"></a>00175         tw_memory       *b;
<a name="l00176"></a>00176         tw_lp           *l = NULL;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         rn_lp_state     *state = NULL;
<a name="l00179"></a>00179         rn_stream       *<a class="code" href="ospf-extern_8h.html#b4c6c03359486e6fb0ac52a94493df1e">s</a> = NULL;
<a name="l00180"></a>00180         rn_message      *rn_msg;
<a name="l00181"></a>00181         rn_machine      *m;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         rn_msg = tw_event_data(new_event);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="keywordflow">if</span>(new_event-&gt;src_lp == NULL || new_event-&gt;src_lp-&gt;pe-&gt;cev_abort)
<a name="l00186"></a>00186         {
<a name="l00187"></a>00187                 <span class="keywordflow">return</span>;
<a name="l00188"></a>00188         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02193085e792a05c4538ec2bc24c845652">DOWNSTREAM</a>)
<a name="l00189"></a>00189         {
<a name="l00190"></a>00190                 state = (rn_lp_state *) new_event-&gt;src_lp-&gt;cur_state;
<a name="l00191"></a>00191                 s = <a class="code" href="rn-extern_8h.html#af86a65184f40426de1361196ef45cef">rn_getstream</a>(new_event-&gt;src_lp);
<a name="l00192"></a>00192         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a>)
<a name="l00193"></a>00193         {
<a name="l00194"></a>00194                 state = (rn_lp_state *) new_event-&gt;dest_lp-&gt;cur_state;
<a name="l00195"></a>00195                 s = <a class="code" href="rn-extern_8h.html#70fa5882507af4b8bd22a59ab93cfa30">rn_getstream_byport</a>(state, rn_msg-&gt;port);
<a name="l00196"></a>00196         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef021ea328a644e627283a35716a54108248">DIRECT</a>)
<a name="l00197"></a>00197         {
<a name="l00198"></a>00198                 tw_event_send(new_event);
<a name="l00199"></a>00199                 <span class="keywordflow">return</span>;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="preprocessor">#if 0</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>                <span class="comment">/*</span>
<a name="l00203"></a>00203 <span class="comment">                 * This is totally out-of-band .. similiar to a SIG_ALARM</span>
<a name="l00204"></a>00204 <span class="comment">                 * on the local machine</span>
<a name="l00205"></a>00205 <span class="comment">                 */</span>
<a name="l00206"></a>00206                 state = (rn_lp_state *) new_event-&gt;src_lp-&gt;cur_state;
<a name="l00207"></a>00207                 s = <a class="code" href="rn-extern_8h.html#af86a65184f40426de1361196ef45cef">rn_getstream</a>(new_event-&gt;src_lp);
<a name="l00208"></a>00208                 l = state-&gt;cur_lp = &amp;s-&gt;layers[s-&gt;cur_layer].lp;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210                 (*l-&gt;type.event)
<a name="l00211"></a>00211                         (l-&gt;cur_state,
<a name="l00212"></a>00212                         &amp;new_event-&gt;cv,
<a name="l00213"></a>00213                         (<span class="keywordtype">void</span> *) rn_msg, l);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                 <span class="keywordflow">return</span>;
<a name="l00216"></a>00216 <span class="preprocessor">#endif</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>        } <span class="keywordflow">else</span>
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219                 tw_error(TW_LOC, <span class="stringliteral">"Unknown event type sent!"</span>);
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         <span class="comment">/*</span>
<a name="l00223"></a>00223 <span class="comment">         * If direction is UP, and more layers, send up to next layer.</span>
<a name="l00224"></a>00224 <span class="comment">         * If direction is down, and more layers, send down to next layer</span>
<a name="l00225"></a>00225 <span class="comment">         *</span>
<a name="l00226"></a>00226 <span class="comment">         * If direction is UP, and at top, nowhere else to go, </span>
<a name="l00227"></a>00227 <span class="comment">         *                      so done, consider it processed.</span>
<a name="l00228"></a>00228 <span class="comment">         *</span>
<a name="l00229"></a>00229 <span class="comment">         * If direction is down, and no more layers, tw_event_send it.</span>
<a name="l00230"></a>00230 <span class="comment">         */</span>
<a name="l00231"></a>00231         <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a> &amp;&amp; s-&gt;cur_layer &gt; 0)
<a name="l00232"></a>00232         {
<a name="l00233"></a>00233                 s-&gt;cur_layer--;
<a name="l00234"></a>00234                 l = state-&gt;cur_lp = &amp;s-&gt;layers[s-&gt;cur_layer].lp;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                 <span class="keywordflow">if</span>(s-&gt;cur_layer == 0)
<a name="l00237"></a>00237                         state-&gt;cev = NULL;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(rn_msg-&gt;src == 338 &amp;&amp; rn_msg-&gt;dst == 8026)
<a name="l00241"></a>00241                 printf(<span class="stringliteral">"%d RN: layer %d sending msg UP, src %d,  dst %d, %lf \n"</span>,
<a name="l00242"></a>00242                         (<span class="keywordtype">int</span>) l-&gt;id, 
<a name="l00243"></a>00243                         s-&gt;cur_layer + 1,
<a name="l00244"></a>00244                         (<span class="keywordtype">int</span>) new_event-&gt;src_lp-&gt;id,
<a name="l00245"></a>00245                         (<span class="keywordtype">int</span>) new_event-&gt;dest_lp-&gt;id,
<a name="l00246"></a>00246                         new_event-&gt;recv_ts);
<a name="l00247"></a>00247 <span class="preprocessor">#endif</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>
<a name="l00249"></a>00249                 (*l-&gt;type.event)
<a name="l00250"></a>00250                         (l-&gt;cur_state,
<a name="l00251"></a>00251                         &amp;new_event-&gt;cv,
<a name="l00252"></a>00252                         (<span class="keywordtype">void</span> *) rn_msg,
<a name="l00253"></a>00253                         new_event-&gt;dest_lp);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                 s-&gt;cur_layer++;
<a name="l00256"></a>00256                 state-&gt;cur_lp = &amp;s-&gt;layers[s-&gt;cur_layer].lp;
<a name="l00257"></a>00257                 state-&gt;l_stats.s_nevents_processed++;
<a name="l00258"></a>00258         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02193085e792a05c4538ec2bc24c845652">DOWNSTREAM</a> &amp;&amp; s-&gt;cur_layer &lt; s-&gt;nlayers - 1)
<a name="l00259"></a>00259         {
<a name="l00260"></a>00260                 s-&gt;cur_layer++;
<a name="l00261"></a>00261                 l = state-&gt;cur_lp = &amp;s-&gt;layers[s-&gt;cur_layer].lp;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263                 <span class="keywordflow">if</span>(!l)
<a name="l00264"></a>00264                         tw_error(TW_LOC, <span class="stringliteral">"NO LP!"</span>);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(rn_msg-&gt;src == 338 &amp;&amp; rn_msg-&gt;dst == 8026)
<a name="l00268"></a>00268                 printf(<span class="stringliteral">"%d RN: layer %d sending msg DOWN, dst %d, ts %f \n"</span>,
<a name="l00269"></a>00269                         (<span class="keywordtype">int</span>) l-&gt;id, 
<a name="l00270"></a>00270                         (<span class="keywordtype">int</span>) s-&gt;cur_layer - 1,
<a name="l00271"></a>00271                         (<span class="keywordtype">int</span>) new_event-&gt;dest_lp-&gt;id,
<a name="l00272"></a>00272                         new_event-&gt;recv_ts);
<a name="l00273"></a>00273 <span class="preprocessor">#endif</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>
<a name="l00275"></a>00275                 (*l-&gt;type.event)
<a name="l00276"></a>00276                         (l-&gt;cur_state,
<a name="l00277"></a>00277                         &amp;new_event-&gt;cv,
<a name="l00278"></a>00278                         (<span class="keywordtype">void</span> *) rn_msg,
<a name="l00279"></a>00279                         new_event-&gt;src_lp);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281                 <span class="comment">// Restore the cur_layer when this lvl of recursion is complete</span>
<a name="l00282"></a>00282                 s-&gt;cur_layer--;
<a name="l00283"></a>00283                 state-&gt;cev = NULL;
<a name="l00284"></a>00284                 state-&gt;cur_lp = &amp;s-&gt;layers[s-&gt;cur_layer].lp;
<a name="l00285"></a>00285                 state-&gt;l_stats.s_nevents_processed++;
<a name="l00286"></a>00286         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02193085e792a05c4538ec2bc24c845652">DOWNSTREAM</a>)
<a name="l00287"></a>00287         {
<a name="l00288"></a>00288                 <span class="comment">// Ok, so now we have reached the bottom of the stack and</span>
<a name="l00289"></a>00289                 <span class="comment">// can remove the event finally.</span>
<a name="l00290"></a>00290                 <span class="keywordflow">if</span>(new_event-&gt;src_lp-&gt;pe-&gt;cev_abort)
<a name="l00291"></a>00291                 {
<a name="l00292"></a>00292                         <span class="keywordflow">while</span>(NULL != (b = new_event-&gt;memory))
<a name="l00293"></a>00293                         {
<a name="l00294"></a>00294                                 new_event-&gt;memory = b-&gt;next;
<a name="l00295"></a>00295                                 tw_memory_alloc_rc(new_event-&gt;src_lp, b, (tw_fd) b-&gt;prev);
<a name="l00296"></a>00296                         }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                         <span class="keywordflow">return</span>;
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="preprocessor">#if VERIFY_RN</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(rn_msg-&gt;src == 338 &amp;&amp; rn_msg-&gt;dst == 8026)
<a name="l00303"></a>00303                 printf(<span class="stringliteral">"%d RN: Sending remote event (%d) from layer %d: %d -%f-&gt; %d \n"</span>,
<a name="l00304"></a>00304                                 (<span class="keywordtype">int</span>) new_event-&gt;src_lp-&gt;id,
<a name="l00305"></a>00305                                 (<span class="keywordtype">int</span>) new_event,
<a name="l00306"></a>00306                                 s-&gt;cur_layer,
<a name="l00307"></a>00307                                 (<span class="keywordtype">int</span>) new_event-&gt;src_lp-&gt;id,
<a name="l00308"></a>00308                                 new_event-&gt;recv_ts,
<a name="l00309"></a>00309                                 (<span class="keywordtype">int</span>) new_event-&gt;dest_lp-&gt;id);
<a name="l00310"></a>00310 <span class="preprocessor">#endif</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>                <span class="comment">/*</span>
<a name="l00312"></a>00312 <span class="comment">                 * This is where we would want to do things like fixing up </span>
<a name="l00313"></a>00313 <span class="comment">                 * the timestamp on the </span>
<a name="l00314"></a>00314 <span class="comment">                 * message, and the dest_lp pointer in the event.  We need to </span>
<a name="l00315"></a>00315 <span class="comment">                 * change the dest_lp appropriately in order to reflect </span>
<a name="l00316"></a>00316 <span class="comment">                 * the final destination considering the connection and/or nbr </span>
<a name="l00317"></a>00317 <span class="comment">                 */</span>
<a name="l00318"></a>00318                 rn_msg-&gt;type = <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a>;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320                 m = <a class="code" href="rn-extern_8h.html#b586ebafc20ad652dd538635f5c816b0">rn_getmachine</a>(new_event-&gt;src_lp-&gt;id);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322                 <span class="keywordflow">if</span>(m-&gt;type == <a class="code" href="rn-types_8h.html#c37ecf88c448feb116c70fd006409a84c617d746aac95241491603aa946adccc">c_host</a>)
<a name="l00323"></a>00323                         new_event-&gt;dest_lp = (tw_lp *) m-&gt;link[0].addr; 
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                 tw_event_send(new_event);
<a name="l00326"></a>00326                 state-&gt;cev = NULL;
<a name="l00327"></a>00327         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rn_msg-&gt;type == <a class="code" href="rn-types_8h.html#3fc738f2924cae2b2d04a9a133c3ef02c7fd648c8ce81263fefd787373903e5c">UPSTREAM</a>)
<a name="l00328"></a>00328         {
<a name="l00329"></a>00329                 tw_error(TW_LOC, <span class="stringliteral">"%lld: sending message up, top-most layer!? \n"</span>, 
<a name="l00330"></a>00330                                 new_event-&gt;src_lp-&gt;gid);
<a name="l00331"></a>00331         } <span class="keywordflow">else</span>
<a name="l00332"></a>00332         {
<a name="l00333"></a>00333                 tw_error(TW_LOC, <span class="stringliteral">"no send?"</span>);
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Jan 27 09:38:30 2009 for ROSS.Net by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
